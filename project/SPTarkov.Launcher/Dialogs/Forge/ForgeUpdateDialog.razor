@inject ISnackbar Snackbar
@inject IJSRuntime JsRuntime
@inject ModManager ModManager
@inject ILogger<ForgeDownloadDialog> Logger
@inject HttpHelper HttpHelper

<MudDialog Class="mud-background-gray border-2 border-solid mud-border-lines-default">
    <DialogContent>
        @if (!CheckedForUpdates)
        {
            <MudContainer Class="d-flex flex-column gap-1 mt-4">
                <MudPaper Class="mud-background-gray border-2 border-solid mud-border-lines-default mb-4 pa-2">
                    <MudText>@_taskText</MudText>
                </MudPaper>
                <MudContainer Class="mb-4 pa-0">
                    <MudButton Class="mud-button-border-copy border-2 border-solid mud-button-inner-text-copy" Variant="Variant.Filled" Color="Color.Dark" StartIcon="@Icons.Material.Filled.Download" IconColor="Color.Success" OnClick="CheckForUpdates" Disabled="@_requestInProgress">Check for Updates</MudButton>
                    <MudButton Class="mud-button-border-copy border-2 border-solid mud-button-inner-text-copy" Variant="Variant.Filled" Color="Color.Dark" OnClick="UserCancelled">Close</MudButton>
                </MudContainer>
            </MudContainer>
        }
        else if (CheckedForUpdates && ForgeUpdateResponse is not null && ForgeUpdateResponse.Success && ForgeUpdateResponse.Data.Updates.Any())
        {
            <MudContainer Class="d-flex flex-column gap-1 mt-4">
                <MudPaper Class="mud-background-gray border-2 border-solid mud-border-lines-default mb-4 pa-2">
                    <MudText>@_taskText</MudText>
                    <MudDivider DividerType="DividerType.Middle" />
                    @foreach (var item in ForgeUpdateResponse.Data.Updates)
                    {
                        <MudText Class="py-2">@item.CurrentVersion.Name</MudText>
                    }
                </MudPaper>
                <MudContainer Class="mb-4 pa-0">
                    <MudButton Class="mud-button-border-copy border-2 border-solid mud-button-inner-text-copy" Variant="Variant.Filled" Color="Color.Dark" StartIcon="@Icons.Material.Filled.Download" IconColor="Color.Success" OnClick="RunUpdates" Disabled="@_requestInProgress">Update Mods</MudButton>
                    <MudButton Class="mud-button-border-copy border-2 border-solid mud-button-inner-text-copy" Variant="Variant.Filled" Color="Color.Dark" OnClick="UserCancelled">Cancel</MudButton>
                </MudContainer>
            </MudContainer>
        }
    </DialogContent>
</MudDialog>

@code {
    [CascadingParameter] private IMudDialogInstance MudDialog { get; set; }
    private bool _requestInProgress;
    private CancellationTokenSource Token { get; set; }
    private bool UserCancel { get; set; }
    private string _taskText = "Check for updates?";
    private bool CheckedForUpdates { get; set; }
    private ForgeUpdateResponse ForgeUpdateResponse { get; set; }

    private async Task<ForgeUpdateResponse?> CallForge(string taskText = "", string failString = "")
    {
        try
        {
            Token = new CancellationTokenSource(TimeSpan.FromSeconds(10));
            _taskText = taskText;
            StateHasChanged();
            await Task.Delay(20);

            var listOfModsToCheck = ModManager.GetMods().Where(w => !w.Value.IsInstalled).Select(x => $"{x.Key}:{x.Value.ModVersion}").ToList();

            var response = await HttpHelper.ForgeGetUpdate(listOfModsToCheck, "4.0.7", Token.Token);

            if (response is null)
            {
                Logger.LogError("Forge ForgeGetUpdate response is null");
            }

            if (response!.Success)
            {
                Logger.LogInformation("Forge ForgeGetUpdate Authenticated");
            }

            if (!response.Success)
            {
                Logger.LogInformation("Forge ForgeGetUpdate NOT - Authenticated");
                Token?.Dispose();
                AbortOrFail(failString);
            }

            return response;
        }
        catch (Exception)
        {
            AbortOrFail(failString);
        }

        return null;
    }

    private async Task CheckForUpdates()
    {
        _requestInProgress = true;
        Token = new CancellationTokenSource(); // Dont give a timeout, some people might just have shit internet
        try
        {
            ForgeUpdateResponse = await CallForge("Checking for updates", "Failed to check for updates");
            // we abort if failed so no need to check result
            CheckedForUpdates = true;

            if (!ForgeUpdateResponse.Data.Updates.Any())
            {
                Snackbar.Add("No update detected", Severity.Info);
                Submit();
                return;
            }

            _taskText = "Below mods have available updates!";
        }
        catch (TaskCanceledException) when (Token.IsCancellationRequested)
        {
            AbortOrFail("Request Timed out!");
            return;
        }
        catch (HttpRequestException)
        {
            AbortOrFail();
            return;
        }
        catch (Exception)
        {
            AbortOrFail();
            return;
        }

        _requestInProgress = false;
    }

    private async Task RunUpdates()
    {
        _taskText = "Updating mods";
        StateHasChanged();

        foreach (var forgeModUpdate in ForgeUpdateResponse.Data.Updates)
        {
            await ModManager.UpdateMod(forgeModUpdate, Token);
        }

        _taskText = "Updates complete";
        StateHasChanged();
        await Task.Delay(1000);

        Submit();
    }

    private void Submit()
    {
        MudDialog.Close(DialogResult.Ok(true));
    }

    private void AbortOrFail(string message = "Cancelled Update")
    {
        if (!UserCancel)
        {
            Snackbar.Add(message, Severity.Error);
        }

        Token?.Cancel();
        MudDialog.Cancel();
        _requestInProgress = false;
    }

    private void UserCancelled()
    {
        UserCancel = true;
        _requestInProgress = false;
        Token?.Cancel();
        MudDialog.Cancel();
    }

}
