@inject ISnackbar Snackbar
@inject IJSRuntime JsRuntime
@inject ModManager ModManager
@inject ILogger<ForgeDownloadDialog> Logger

<MudDialog Class="mud-background-gray border-2 border-solid mud-border-lines-default">
    <DialogContent>
        <MudContainer Class="d-flex flex-column gap-1 mt-4">
            <MudPaper Class="mud-background-gray border-2 border-solid mud-border-lines-default mb-4 pa-2">
                <MudText>Please make sure to read the mod page and this versions changes!</MudText>
            </MudPaper>
            <MudPaper Class="mud-background-gray border-2 border-solid mud-border-lines-default mb-4 pa-2">
                <MudText Class="user-markdown">
                    @((MarkupString)Version.Description)
                </MudText>
            </MudPaper>
            <MudContainer Class="mb-4 pa-0">
                <MudButton Class="mud-button-border-copy border-2 border-solid mud-button-inner-text-copy" Variant="Variant.Filled" Color="Color.Dark" StartIcon="@Icons.Material.Filled.Download" IconColor="Color.Success" OnClick="RunDownloadTask" Disabled="@_requestInProgress">Download</MudButton>
                <MudButton Class="mud-button-border-copy border-2 border-solid mud-button-inner-text-copy" Variant="Variant.Filled" Color="Color.Dark" OnClick="UserCancelled">Close</MudButton>
            </MudContainer>
        </MudContainer>
    </DialogContent>
</MudDialog>

@code {
    [CascadingParameter] private IMudDialogInstance MudDialog { get; set; }
    [Parameter] public ForgeBase Mod { get; set; }
    [Parameter] public ForgeModVersion Version { get; set; }
    private bool _requestInProgress;
    private CancellationTokenSource Token { get; set; }
    private bool UserCancel { get; set; }

    protected override Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender)
        {
            JsRuntime.InvokeVoidAsync("setTabContent");
        }

        return base.OnAfterRenderAsync(firstRender);
    }

    private void RunDownloadTask()
    {
        _requestInProgress = true;
        Token = new CancellationTokenSource(); // Dont give a timeout, some people might just have shit internet
        try
        {
            // TODO: atm we dont do anything with cancellationToken.
            if (!ModManager.StartModDownload(Mod, Version, Token))
            {
                Logger.LogError("Unable to add download task, name: {name}, url: {url}", Mod.Name, Version.Link);
                Snackbar.Add($"Unable to download {Mod.Name}", Severity.Error);
            }
        }
        catch (TaskCanceledException) when (Token.IsCancellationRequested)
        {
            AbortOrFail("Request Timed out!");
            return;
        }
        catch (HttpRequestException)
        {
            AbortOrFail();
            return;
        }
        catch (Exception)
        {
            AbortOrFail();
            return;
        }

        if (true)
        {
            _requestInProgress = false;
            Submit();
        }
    }

    private void Submit()
    {
        Snackbar.Add($"Download started for {Mod.Name}", Severity.Success);
        MudDialog.Close();
    }

    private void AbortOrFail(string message = "Cancelled download")
    {
        if (!UserCancel)
        {
            Snackbar.Add(message, Severity.Error);
        }

        Token?.Cancel();
        MudDialog.Cancel();
        _requestInProgress = false;
    }

    private void UserCancelled()
    {
        UserCancel = true;
        _requestInProgress = false;
        Token?.Cancel();
        MudDialog.Cancel();
    }
}
