@inject ISnackbar Snackbar
@inject IJSRuntime JsRuntime

<MudDialog Class="mud-background-gray border-2 border-solid mud-border-lines-default">
    <DialogContent>
        <MudContainer Class="d-flex flex-column gap-1 mt-4">
            <MudPaper Class="mud-background-gray border-2 border-solid mud-border-lines-default mb-4 pa-2">
                <MudText>Please make sure to read the mod page and this version changes!</MudText>
            </MudPaper>
            <MudPaper Class="mud-background-gray border-2 border-solid mud-border-lines-default mb-4 pa-2">
                <MudText Class="user-markdown">
                    @((MarkupString)VersionDescription)
                </MudText>
            </MudPaper>
            <MudContainer Class="mb-4 pa-0">
                <MudButton Class="mud-button-border-copy border-2 border-solid mud-button-inner-text-copy" Variant="Variant.Filled" Color="Color.Dark" StartIcon="@Icons.Material.Filled.Download" IconColor="Color.Success" OnClick="RunDownloadTask" Disabled="@_requestInProgress">Download</MudButton>
                <MudButton Class="mud-button-border-copy border-2 border-solid mud-button-inner-text-copy" Variant="Variant.Filled" Color="Color.Dark" OnClick="UserCancelled">Close</MudButton>
            </MudContainer>
        </MudContainer>
    </DialogContent>
</MudDialog>

@code {
    [CascadingParameter] private IMudDialogInstance MudDialog { get; set; }
    [Parameter] public string Name { get; set; }
    [Parameter] public string VersionDescription { get; set; }
    [Parameter] public string VersionLink { get; set; }

    private bool _requestInProgress;
    private CancellationTokenSource Token { get; set; }
    private bool UserCancel { get; set; }

    protected override Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender)
        {
            JsRuntime.InvokeVoidAsync("setTabContent");
        }

        return base.OnAfterRenderAsync(firstRender);
    }

    private Task RunDownloadTask()
    {
        // start thread and download there. store somewhere and have a way to see them.
        _requestInProgress = true;
        try
        {
        }
        catch (TaskCanceledException) when (Token.IsCancellationRequested)
        {
            AbortOrFail("Request Timed out!");
            return Task.CompletedTask;
        }
        catch (HttpRequestException)
        {
            AbortOrFail();
            return Task.CompletedTask;
        }
        catch (Exception)
        {
            AbortOrFail();
            return Task.CompletedTask;
        }

        if (true)
        {
            _requestInProgress = false;
            Submit();
        }

        return Task.CompletedTask;
    }

    private void Submit()
    {
        Snackbar.Add($"Download started for {Name}", Severity.Success);
        MudDialog.Close();
    }

    private void AbortOrFail(string message = "Cancelled download")
    {
        if (!UserCancel)
        {
            Snackbar.Add(message, Severity.Error);
        }

        Token?.Cancel();
        MudDialog.Cancel();
        _requestInProgress = false;
    }

    private void UserCancelled()
    {
        UserCancel = true;
        _requestInProgress = false;
        Token?.Cancel();
        MudDialog.Cancel();
    }

}
