@inject ILogger<SettingsTopPanelComponent> Logger
@inject ConfigHelper ConfigHelper
@inject HttpHelper HttpHelper
@inject ISnackbar Snackbar
@inject LocaleHelper LocaleHelper
@inject WindowsClipboard Clipboard

<MudContainer Class="pa-0 pb-4 d-flex justify-start gap-2">
    <MudButton Color="Color.Dark" Size="Size.Small" Variant="Variant.Filled" OnClick="LoadLiveSettings">@(LocaleHelper.Get("setting_load_live"))</MudButton>
    <MudButton Color="Color.Dark" Size="Size.Small" Variant="Variant.Filled" OnClick="ClearGameSettings">@(LocaleHelper.Get("setting_clear_game"))</MudButton>
    <MudButton Color="Color.Dark" Size="Size.Small" Variant="Variant.Filled" OnClick="CleanTempFiles">@(LocaleHelper.Get("setting_clean_temp"))</MudButton>
    <MudButton Disabled="!IsWindows" Color="Color.Dark" Size="Size.Small" Variant="Variant.Filled" OnClick="CopyLogs">@(LocaleHelper.Get("setting_copy_logs"))</MudButton>
    <MudButton Color="Color.Dark" Size="Size.Small" Variant="Variant.Filled" OnClick="ClearApiKey">@(LocaleHelper.Get("setting_clear_api"))</MudButton>
</MudContainer>

@code {

    private bool IsWindows => OperatingSystem.IsWindows();

    private async Task LoadLiveSettings()
    {
        Logger.LogInformation("Loading Live Settings");
        var eftSettingsFolder = Path.Combine(Environment.GetFolderPath(Environment.SpecialFolder.ApplicationData), "Battlestate Games", "Escape From Tarkov", "Settings");
        var sptSettingsFolder = Path.Combine(ConfigHelper.GetConfig().GamePath, "user", "sptsettings");

        if (!Directory.Exists(eftSettingsFolder))
        {
            Logger.LogWarning("Settings can not be loaded from live, path given: {EftSettingsFolder}", eftSettingsFolder);
            Snackbar.Add(LocaleHelper.Get("setting_load_live_error_1"), Severity.Error);
            return;
        }

        try
        {
            Directory.CreateDirectory(sptSettingsFolder);

            foreach (var path in Directory.GetDirectories(eftSettingsFolder, "*", SearchOption.AllDirectories))
            {
                Directory.CreateDirectory(path.Replace(eftSettingsFolder, sptSettingsFolder));
            }

            foreach (var file in Directory.GetFiles(eftSettingsFolder, "*.*", SearchOption.AllDirectories))
            {
                File.Copy(file, file.Replace(eftSettingsFolder, sptSettingsFolder), true);
            }
        }
        catch (Exception e)
        {
            Logger.LogWarning("Unable to load live settings {Exception}", e);
            Snackbar.Add(LocaleHelper.Get("setting_load_live_error_2"), Severity.Error);
            return;
        }

        Logger.LogInformation("Loaded live settings to SPTsettings folder");
        Snackbar.Add(LocaleHelper.Get("setting_load_live_success"), Severity.Success);
    }

    private async Task ClearGameSettings()
    {
        Logger.LogInformation("clearing game settings");
        var sptSettings = new DirectoryInfo(Path.Combine(ConfigHelper.GetConfig().GamePath, "user", "sptsettings"));

        try
        {
            sptSettings.Delete(true);

            Directory.CreateDirectory(sptSettings.FullName);
        }
        catch (Exception e) when (e is IOException or UnauthorizedAccessException)
        {
            Logger.LogError("Unable to clean game settings, UnauthorizedAccessException or IOException: {Exception}", e);
            Snackbar.Add(LocaleHelper.Get("setting_clear_game_error_1"), Severity.Error);
            return;
        }
        catch (Exception e)
        {
            Logger.LogError("Clearing game settings failed: {Exception}", e);
            Snackbar.Add(LocaleHelper.Get("setting_clear_game_error_2"), Severity.Error);
            return;
        }

        Logger.LogInformation("Cleared game settings");
        Snackbar.Add(LocaleHelper.Get("setting_clear_game_success"), Severity.Success);
    }

    private async Task CleanTempFiles()
    {
        try
        {
            var tempFolder = new DirectoryInfo(Path.Join(ConfigHelper.GetConfig().GamePath, "user", "sptappdata"));
            tempFolder.Delete(true);
        }
        catch (Exception e) when (e is IOException or UnauthorizedAccessException)
        {
            Logger.LogError("Unable to clean temp files, UnauthorizedAccessException or IOException: {Exception}", e);
            Snackbar.Add(LocaleHelper.Get("setting_clean_temp_error_1"), Severity.Warning);
            return;
        }
        catch (Exception e)
        {
            Logger.LogError("Unable to clean temp files: {Exception}", e);
            Snackbar.Add(LocaleHelper.Get("setting_clean_temp_error_2"), Severity.Error);
            return;
        }

        Logger.LogInformation("Cleaned temp files");
        Snackbar.Add(LocaleHelper.Get("setting_clean_temp_success"), Severity.Success);
    }

    private async Task CopyLogs()
    {
        var filesToCopy = new List<string>();
        var path = ConfigHelper.GetConfig().GamePath;
        var bepinPath = Path.Combine(path, "BepInEx", "LogOutput.log");
        var serverPath = Path.Combine(path, "user", "logs", $"server-{DateTime.Now:yyyy-MM-dd}.log");
        var launcherPath = Path.Combine(path, "user", "logs", "launcher.log");
        var tracePath = Path.Combine(path, "Logs");
        // var profilePath = Path.Combine(path, "user", "profiles", $"{AccountManager.SelectedAccount.id}.json")) TODO: needs to be reworked to deal with new multiprofile approach

        if (File.Exists(bepinPath))
        {
            filesToCopy.Add(bepinPath);
        }

        if (File.Exists(serverPath))
        {
            filesToCopy.Add(serverPath);
        }

        if (File.Exists(launcherPath))
        {
            filesToCopy.Add(launcherPath);
        }

        if (Directory.Exists(tracePath))
        {
            var logs = Directory.GetFiles(tracePath, $"{DateTime.Now:yyyy.MM.dd}_* traces.log", SearchOption.AllDirectories);

            var log = logs.Length > 0 ? logs.FirstOrDefault() : "";

            if (!string.IsNullOrWhiteSpace(log))
            {
                filesToCopy.Add(log);
            }
        }

        // TODO: profile - if not logged in show dialog to choose profile to copy

        try
        {
            CopyFilePathsToClipboard(filesToCopy);
        }
        catch (Exception e)
        {
            Logger.LogError("Unable to set clipboard with logs: {Exception}", e);
            Snackbar.Add(LocaleHelper.Get("setting_copy_logs_error_1"), Severity.Error);
            return;
        }

        Logger.LogInformation("Copied {Count} log/s to clipboard", filesToCopy.Count);
        Snackbar.Add(LocaleHelper.Get("setting_copy_logs_success"), Severity.Success);
    }

    private void CopyFilePathsToClipboard(List<string> filePaths)
    {
        if (!IsWindows)
        {
            // added this just incase for whatever reason disabling the button doesnt work.
            Logger.LogWarning("Clipboard.CopyFiles is not supported on this platform");
            return;
        }

        Clipboard.CopyFiles(filePaths.ToArray());
    }

    private async Task ClearApiKey()
    {
        ForgeLogoutResponse result;
        try
        {
            var token = new CancellationTokenSource(TimeSpan.FromSeconds(10));
            result = await HttpHelper.ForgeLogout(token.Token);
        }
        catch (Exception e)
        {
            Logger.LogError("Exception thrown from SettingsTopPanelComponent.ClearApiKey: {Exception}", e);
            Snackbar.Add(LocaleHelper.Get("setting_clear_api_error_1"), Severity.Error);
            return;
        }

        if (result is null)
        {
            Logger.LogError("Forge ForgeLogout result is null");
            Snackbar.Add(LocaleHelper.Get("setting_clear_api_error_1"), Severity.Error);
            return;
        }

        if (result.Code == ForgeResponseMessage.Unauthenticated)
        {
            Logger.LogWarning("Forge ForgeLogout failed to authenticate");
            Snackbar.Add(LocaleHelper.Get("setting_clear_api_error_1"), Severity.Error);
            return;
        }

        if (result.Success)
        {
            Logger.LogInformation("Forge ForgeLogout Successful");
            Snackbar.Add(LocaleHelper.Get("setting_clear_api_success"), Severity.Error);
            HttpHelper.ClearApiKey();
        }
    }
}
