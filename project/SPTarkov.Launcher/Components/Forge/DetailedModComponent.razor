@inject IJSRuntime JsRuntime
@inject LocaleHelper LocaleHelper
@inject IDialogService DialogService
@inject ConfigHelper ConfigHelper
@inject ILogger<DetailedModComponent> Logger
@inject NavigationManager NavigationManager

<MudItem sm="12">
    @if (IsSkeleton)
    {
        // Create replica of Below layout as a skeleton
        <MudGrid>
            <MudItem sm="8">
                <MudSkeleton SkeletonType="SkeletonType.Rectangle" Width="100%" Height="200px" Class="mb-4"/>
                <MudSkeleton SkeletonType="SkeletonType.Rectangle" Width="100%" Height="100px" Class="mb-4"/>
                <MudSkeleton SkeletonType="SkeletonType.Rectangle" Width="100%" Height="300px"/>
            </MudItem>
            <MudItem sm="4">
                <MudSkeleton SkeletonType="SkeletonType.Rectangle" Width="100%" Height="300px" Class="mb-4"/>
                <MudSkeleton SkeletonType="SkeletonType.Rectangle" Width="100%" Height="100px"/>
            </MudItem>
        </MudGrid>
    }
    else
    {
        <MudGrid>
            <MudItem sm="12" Class="d-flex flex-row">
                <MudButton StartIcon="@Icons.Material.Filled.ArrowBack" IconColor="Color.Error" Color="Color.Dark" Size="Size.Medium" Class="mud-button-border-copy border-2 border-solid mud-button-inner-text-copy" OnClick="NavigateBack">
                    Back
                </MudButton>
                <MudSpacer/>
                <MudButton Color="Color.Dark" StartIcon="@Icons.Material.Filled.Download" IconColor="Color.Success" Variant="Variant.Filled" Class="mud-button-border-copy border-2 border-solid mud-button-inner-text-copy" OnClick="StartDownloadModTask">
                    @($"Download Latest ({ForgeModVersion?.Version})")
                </MudButton>
            </MudItem>
            <MudItem sm="8" Class="pt-4">
                <MudCard Class="mud-background-gray border-2 border-solid mud-border-lines-default mb-4">
                    <MudCardHeader>
                        <MudGrid>
                            <MudItem sm="3">
                                <MudImage Src=@(ForgeMod.GetThumbnail()) Class="mod-thumbnail" Style="background-color: transparent !important;"/>
                            </MudItem>
                            <MudItem sm="9">
                                <MudItem Class="d-flex mud-width-full">
                                    <MudTooltip Arrow="false" Placement="Placement.Bottom" Color="Color.Default" ShowOnHover="true" ShowOnClick="false" ShowOnFocus="false" Text="Open in the Forge">
                                        <MudLink Color="Color.Default" Underline="Underline.Always" Href="@($"https://forge.sp-tarkov.com/mod/{ForgeMod.Id}/{ForgeMod.Slug}/")" Typo="Typo.h6">@ForgeMod.Name</MudLink>
                                    </MudTooltip>
                                </MudItem>
                                <MudText Typo="Typo.body1" Class="no-pointers no-select">By @ForgeMod.GetModdersName()</MudText>
                                <MudText Typo="Typo.body2" Class="no-pointers no-select">@ForgeMod.Downloads Downloads</MudText>
                            </MudItem>
                        </MudGrid>
                    </MudCardHeader>
                    <MudCardContent>
                        <MudText>@ForgeMod.Teaser</MudText>
                    </MudCardContent>
                </MudCard>
                <MudCard Class="mud-background-gray border-2 border-solid mud-border-lines-default">
                    <MudCardContent Class="user-markdown">@((MarkupString)ForgeMod.Description)</MudCardContent>
                </MudCard>
            </MudItem>
            <MudItem sm="4" Class="pt-4">
                <MudCard Class="mud-background-gray border-2 border-solid mud-border-lines-default">
                    <MudCardContent Class="d-flex flex-column align-start">
                        <MudText Typo="Typo.body1" Class="no-pointers no-select">GUID</MudText>
                        <MudText Typo="Typo.caption" Class="pb-2 text-overflow">@ForgeMod.Guid</MudText>


                        <MudText Typo="Typo.body1" Class="no-pointers no-select">Additional Authors</MudText>
                        <MudText Typo="Typo.caption" Class="pb-2 text-overflow">@(ForgeMod.GetAdditionalAuthors())</MudText> @* TODO: Get aditional author page *@

                        <MudText Typo="Typo.body1" Class="no-pointers no-select">License</MudText>
                        <MudText Typo="Typo.caption" Class="pb-2 text-overflow">
                            @if (ForgeMod.License is not null)
                            {
                                <MudLink Typo="Typo.caption" Color="Color.Default" Underline="Underline.Always" Href="@ForgeMod.License.Link">@ForgeMod.License.Name</MudLink>
                            }
                            else
                            {
                                @("None")
                            }
                        </MudText>

                        <MudText Typo="Typo.body1" Class="no-pointers no-select">Source Code</MudText>
                        @if (ForgeMod.SourceCodeLinks?.Any() ?? false)
                        {
                            @foreach (var link in ForgeMod.SourceCodeLinks)
                            {
                                <MudText Typo="Typo.caption" Class="pb-2 text-overflow">
                                    <MudLink Color="Color.Default" Underline="Underline.Always" Typo="Typo.caption" Href="@link.Url">@(string.IsNullOrEmpty(link.Label) ? link.Url : link.Label)</MudLink>
                                </MudText>
                            }
                        }
                        else
                        {
                            <MudText Typo="Typo.caption" Class="pb-2 text-overflow">
                                @("None")
                            </MudText>
                        }

                        <MudText Typo="Typo.body1" Class="no-pointers no-select">Latest VirusTotal Result</MudText>
                        @if (ForgeModVersion?.VirusTotalLinks?.Any() ?? false)
                        {
                            @foreach (var link in ForgeModVersion.VirusTotalLinks)
                            {
                                <MudText Typo="Typo.caption" Class="pb-2 text-overflow">
                                    <MudLink Color="Color.Default" Underline="Underline.Always" Typo="Typo.caption" Href="@link.Url">@(string.IsNullOrEmpty(link.Label) ? link.Url : link.Label)</MudLink>
                                </MudText>
                            }
                        }
                        else
                        {
                            <MudText Typo="Typo.caption" Class="pb-2 text-overflow">
                                @("None")
                            </MudText>
                        }

                        <MudText Typo="Typo.body1" Class="no-pointers no-select">Fika Compatible</MudText>
                        <MudText Typo="Typo.caption" Class="pb-2 text-overflow">@(ForgeMod.FikaCompatible ?? false ? "Yes" : "No")</MudText>

                        <MudText Typo="Typo.body1" Class="no-pointers no-select">Dependencies</MudText>
                        @if (ForgeModVersion?.Dependencies?.Any() ?? false)
                        {
                            @foreach (var dep in ForgeModVersion.Dependencies)
                            {
                                <MudLink Color="Color.Default" Underline="Underline.None" OnClick="() => NavigateToDependency(dep.Id)" Class="d-flex align-center cursor-pointer setting-on-hover pa-2 mud-width-full overflow-hidden">
                                    <MudImage Class="flex-shrink-0" Width="50" Height="50" Src="@dep.GetThumbnail()"/>
                                    <MudContainer Class="flex-1 gap-3 px-2">
                                        <MudText Class="no-select text-overflow" Typo="Typo.h6">@dep.Name</MudText>
                                        <MudText Class="no-select text-overflow" Typo="Typo.caption">@($"Requires {dep.Versions?.First().Version} - {dep.Owner?.Name}")</MudText>
                                    </MudContainer>
                                </MudLink>
                            }
                        }
                        else
                        {
                            <MudText Typo="Typo.caption" Class="pb-2 text-overflow">
                                @("None")
                            </MudText>
                        }
                    </MudCardContent>
                </MudCard>
                <MudCard Class="mud-background-gray border-2 border-solid mud-border-lines-default mt-4">
                    <MudCardContent Class="d-flex flex-column align-start">
                        <MudText Typo="Typo.body1" Class="no-pointers no-select">ADDONS</MudText>
                        @if (ForgeModAddons?.Any() ?? false)
                        {
                            @foreach (var addon in ForgeModAddons)
                            {
                                @if (!addon.Versions.Select(x => x.ModVersionConstraint?.IsSatisfied(ForgeModVersion?.Version)).Any())
                                {
                                    continue;
                                }

                                <MudLink Color="Color.Default" Underline="Underline.None" Class="d-flex align-center cursor-pointer setting-on-hover pa-2 mud-width-full overflow-hidden">
                                    <MudImage Class="flex-shrink-0" Width="50" Height="50" Src="@addon.GetThumbnail()"/>
                                    <MudContainer Class="flex-1 gap-3 px-2">
                                        <MudText Class="no-select text-overflow" Typo="Typo.h6">@addon.Name</MudText>
                                        <MudText Class="no-select text-overflow" Typo="Typo.caption">@($"Requires {addon.Versions?.First().Version} - {addon.Owner?.Name}")</MudText>
                                    </MudContainer>
                                </MudLink>
                            }
                        }
                        else
                        {
                            <MudText Typo="Typo.caption" Class="pb-2 text-overflow">
                                @("None")
                            </MudText>
                        }
                    </MudCardContent>
                </MudCard>
            </MudItem>
        </MudGrid>
    }
</MudItem>

@code {
    [Parameter] public bool IsSkeleton { get; set; }
    [Parameter] public ForgeBase ForgeMod { get; set; }
    [Parameter] public ForgeModVersion? ForgeModVersion { get; set; }
    [Parameter] public List<ForgeBase>? ForgeModAddons { get; set; }

    protected override Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender)
        {
            JsRuntime.InvokeVoidAsync("setTabContent");
        }

        return base.OnAfterRenderAsync(firstRender);
    }

    private async Task StartDownloadModTask()
    {
        var option = new DialogOptions
        {
            Position = ConfigHelper.DialogOptions.Position,
            BackdropClick = ConfigHelper.DialogOptions.BackdropClick,
            CloseOnEscapeKey = ConfigHelper.DialogOptions.CloseOnEscapeKey,
            NoHeader = ConfigHelper.DialogOptions.NoHeader,
            CloseButton = ConfigHelper.DialogOptions.CloseButton,
            FullScreen = ConfigHelper.DialogOptions.FullScreen,
            FullWidth = ConfigHelper.DialogOptions.FullWidth,
            BackgroundClass = ConfigHelper.DialogOptions.BackgroundClass
        };

        var param = new DialogParameters
        {
            {
                "Mod", ForgeMod
            },
            {
                "Version", ForgeModVersion
            }
        };

        var dialog = await DialogService.ShowAsync<ForgeDownloadDialog>("ForgeDownloadDialog", param, option);
        var result = await dialog.Result;

        if (result?.Canceled is false)
        {
            Logger.LogInformation("Started Download for {mod}", ForgeMod.Name);
            return;
        }

        Logger.LogInformation("Download cancelled for {mod}", ForgeMod.Name);
    }

    private void NavigateBack()
    {
        JsRuntime.InvokeVoidAsync("navigateBack");
        // this doesn't seem to work on linux, so navigating back to forge instead of last page
        if (OperatingSystem.IsWindows())
        {
            JsRuntime.InvokeVoidAsync("navigateBack");
        }
        else
        {
            NavigationManager.NavigateTo("/Forge");
        }
    }

    private void NavigateToDependency(int? depId)
    {
        // TODO: reloading looks awful, but navigating to the same page (different mod) doesnt seem to get blazor to update
        NavigationManager.NavigateTo("/ForgeMod/" + depId, true);
    }

}
