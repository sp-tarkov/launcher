@inject IDialogService DialogService
@inject ConfigHelper ConfigHelper
@inject StateHelper StateHelper
@inject NavigationManager NavigationManager
@inject ILogger<ProfileCardComponent> Logger
@inject LocaleHelper LocaleHelper

<MudItem sm="4">
    <MudPaper Elevation="2" Class="pa-4 d-flex flex-column flex-none gap-2 mud-background-gray border-2 border-solid mud-border-lines-default card-container info-card-height">
        <div class="card-overflow">
            @if (!sideIsUnknown)
            {
                <MudImage Src=@(ImageName()) Elevation="0" Class=@(ImageClassNames())/>
            }
        </div>
        <MudText Class="mb-n4 no-pointers no-select" Typo="Typo.caption">@(LocaleHelper.Get("profile_card_name")):</MudText>
        <MudText Typo="Typo.h6">@MiniProfile.Username</MudText>
        <MudDivider DividerType="DividerType.Middle"/>
        <MudText Class="mb-n4 no-pointers no-select" Typo="Typo.caption">@(LocaleHelper.Get("profile_card_level")):</MudText>
        <MudText Typo="Typo.h6">@MiniProfile.CurrentLevel</MudText>
        <MudDivider DividerType="DividerType.Middle"/>
        <MudText Class="mb-n4 no-pointers no-select" Typo="Typo.caption">@(LocaleHelper.Get("profile_card_edition")):</MudText>
        <MudText Typo="Typo.h6">@MiniProfile.Edition</MudText>
        <MudDivider DividerType="DividerType.Middle"/>
        <MudText Class="mb-n3 no-pointers no-select" Typo="Typo.caption">@(LocaleHelper.Get("profile_card_id")):</MudText>
        <MudText Typo="Typo.body1">@MiniProfile.ProfileID</MudText>
        @if (!HideButtons)
        {
            <MudContainer Class="justify-end d-flex pa-0">

                @if (!MiniProfile.InvalidOrUnloadableProfile)
                {
                    <MudTooltip Arrow="true" Placement="Placement.Left" Text="@(loggedIn ? LocaleHelper.Get("profile_card_logout") : LocaleHelper.Get("profile_card_login"))">
                        <MudIconButton Class="mr-1" Color="Color.Success" Icon="@(!loggedIn ? Icons.Material.Filled.Login : Icons.Material.Filled.Logout)" Size="Size.Small" @onclick="RunLoginTask"/>
                    </MudTooltip>
                }
                else
                {
                    <MudTooltip Arrow="true" Color="Color.Error" Placement="Placement.Left" Text="@(LocaleHelper.Get("profile_card_invalid"))">
                        <MudIconButton Class="mr-1" Color="Color.Error" Icon="@Icons.Material.Filled.Recycling" Size="Size.Small"/>
                    </MudTooltip>
                }

                <MudTooltip Arrow="true" Placement="Placement.Left" Text="@(LocaleHelper.Get("profile_card_delete"))">
                    <MudIconButton Color="Color.Error" Icon="@Icons.Material.Filled.Delete" Size="Size.Small" @onclick="RunDeleteTask"/>
                </MudTooltip>

            </MudContainer>
        }
    </MudPaper>
</MudItem>

@code {
    [Parameter]
    public bool HideButtons { get; set; }

    [Parameter]
    public MiniProfile MiniProfile { get; set; }

    [Parameter]
    public List<MiniProfile> ProfileList { get; set; }

    [Parameter]
    public EventCallback<List<MiniProfile>> ProfileListChanged { get; set; }

    private bool sideIsUnknown { get; set; }
    private bool loggedIn { get; set; }

    private string ImageClassNames()
    {
        return $"no-pointers background-image-{(MiniProfile.Side.ToLower() != "unknown" ? MiniProfile.Side.ToLower() : "usec")}";
    }

    private string ImageName()
    {
        return $"side_{(MiniProfile.Side.ToLower() != "unknown" ? MiniProfile.Side.ToLower() : "usec")}.png";
    }

    protected override void OnInitialized()
    {
        base.OnInitialized();

        loggedIn = StateHelper.SelectedProfile != null && StateHelper.SelectedProfile.ProfileID == MiniProfile.ProfileID;
        if (MiniProfile.Side.ToLower() == "unknown")
        {
            sideIsUnknown = true;
        }
    }

    private async Task RunLoginTask()
    {
        if (StateHelper.SelectedProfile != null)
        {
            if (StateHelper.SelectedProfile.ProfileID == MiniProfile.ProfileID)
            {
                StateHelper.SelectedProfile = null;
                loggedIn = false;
                return;
            }
        }

        var dialogParams = new DialogParameters
        {
            {
                "MiniProfile", MiniProfile
            }
        };

        var dialog = await DialogService.ShowAsync<ProfileLoginDialog>("ProfileLoginDialog", dialogParams, ConfigHelper.DialogOptions);
        var result = await dialog.Result;

        if (result?.Canceled is false)
        {
            StateHelper.SetSelectedProfile(MiniProfile);
            loggedIn = StateHelper.SelectedProfile != null;

            Logger.LogInformation("Navigating to /ServerPageWrapper");
            NavigationManager.NavigateTo("/ServerPageWrapper");
        }
    }

    private async Task RunDeleteTask()
    {
        var dialogParams = new DialogParameters
        {
            {
                "MiniProfile", MiniProfile
            }
        };

        var dialog = await DialogService.ShowAsync<ProfileRemoveDialog>("ProfileRemoveDialog", dialogParams, ConfigHelper.DialogOptions);
        var result = await dialog.Result;

        if (result?.Canceled is false)
        {
            ProfileList = StateHelper.ProfileList;
            await ProfileListChanged.InvokeAsync(ProfileList);
        }
    }

}
