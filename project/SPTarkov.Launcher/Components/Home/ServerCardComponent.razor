@inject IDialogService DialogService
@inject NavigationManager NavigationManager
@inject StateHelper StateHelper
@inject ConfigHelper ConfigHelper
@inject LocaleHelper LocaleHelper

<MudItem md="4">
    <MudPaper Elevation="2" Class="pa-4 d-flex flex-column flex-none gap-2 border-2 border-solid mud-border-lines-default card-container">
        <MudText Class="mb-n4 no-pointers no-select" Typo="Typo.caption">@(LocaleHelper.Get("server_card_name"))</MudText>
        <MudText Typo="Typo.h6">@Server.Name</MudText>
        <MudDivider DividerType="DividerType.Middle"/>
        <MudText Class="mb-n4 no-pointers no-select" Typo="Typo.caption">@(LocaleHelper.Get("server_card_address"))</MudText>
        <MudText Typo="Typo.h6">@Server.IpAddress</MudText>
        <MudContainer Class="d-flex pa-0 flex-row">

            <MudTooltip Color="Color.Dark" Arrow="true" Placement="Placement.Right" Text="@(IsConnectedServer ? LocaleHelper.Get("server_card_connected") : LocaleHelper.Get("server_card_disconnected"))">
                <MudIconButton Icon="@Icons.Material.Filled.Circle" Color="@(IsConnectedServer ? Color.Success : Color.Error)" Size="Size.Small"/>
            </MudTooltip>

            <MudSpacer/>

            <MudTooltip Color="Color.Dark" Arrow="true" Placement="Placement.Left" Text="@(!IsConnectedServer ? LocaleHelper.Get("server_card_login") : LocaleHelper.Get("server_card_logout"))">
                <MudIconButton Class="mr-1" Color="Color.Success" Icon="@(!IsConnectedServer ? Icons.Material.Filled.Login : Icons.Material.Filled.Logout)" Size="Size.Small" OnClick="RunLoginTask"/>
            </MudTooltip>

            @if (!Server.Locked)
            {
                <MudTooltip Color="Color.Dark" Arrow="true" Placement="Placement.Left" Text="@(LocaleHelper.Get("server_card_edit"))">
                    <MudIconButton Icon="@Icons.Material.Filled.Build" Color="Color.Default" Size="Size.Small" OnClick="RunEditTask"/>
                </MudTooltip>
            }

            @if (Server.Locked)
            {
                <MudTooltip Color="Color.Dark" Arrow="true" Placement="Placement.Left" Text="@(LocaleHelper.Get("server_card_protect"))">
                    <MudIconButton Color="Color.Tertiary" Icon="@Icons.Material.Filled.Lock" Size="Size.Small"/>
                </MudTooltip>
            }
            else
            {
                <MudTooltip Color="Color.Dark" Arrow="true" Placement="Placement.Left" Text="@(LocaleHelper.Get("server_card_delete"))">
                    <MudIconButton Color="Color.Error" Icon="@Icons.Material.Filled.Delete" Size="Size.Small" OnClick="RunDeleteTask"/>
                </MudTooltip>
            }

        </MudContainer>
    </MudPaper>
</MudItem>

@code {
    [Parameter] public Server Server { get; set; }

    [Parameter] public List<Server> ServerList { get; set; }

    [Parameter] public EventCallback<List<Server>> ServerListChanged { get; set; }

    private bool IsConnectedServer { get; set; }

    protected override void OnInitialized()
    {
        IsConnectedServer = StateHelper.SelectedServer?.ServerId == Server.ServerId;
        base.OnInitialized();
    }

    private async Task RunEditTask()
    {
        if (StateHelper.SelectedServer?.ServerId == Server.ServerId)
        {
            StateHelper.LogoutAndDispose();
            IsConnectedServer = false;
        }

        var param = new DialogParameters
        {
            {
                "Server", Server
            }
        };

        var dialog = await DialogService.ShowAsync<ServerEditDialog>("ServerEditDialog", param, ConfigHelper.DialogOptions);
        var result = await dialog.Result;

        if (result?.Canceled is false)
        {
            var serverToChange = ServerList.FirstOrDefault(x => x.ServerId == Server.ServerId);

            if (serverToChange != null)
            {
                serverToChange.Name = Server.Name;
                serverToChange.IpAddress = Server.IpAddress;
            }

            ConfigHelper.SetServers(ServerList);
            await ServerListChanged.InvokeAsync(ServerList);
        }
    }

    private async Task RunLoginTask()
    {
        if (StateHelper.SelectedServer != null)
        {
            if (StateHelper.SelectedServer.ServerId == Server.ServerId)
            {
                StateHelper.LogoutAndDispose();
                IsConnectedServer = false;
                return;
            }

            StateHelper.LogoutAndDispose();
            IsConnectedServer = false;
        }

        var param = new DialogParameters
        {
            {
                "Server", Server
            }
        };

        var dialog = await DialogService.ShowAsync<ServerLoginDialog>("ServerLoginDialog", param, ConfigHelper.DialogOptions);
        var result = await dialog.Result;

        if (result?.Canceled is false)
        {
            StateHelper.SetSelectedServer(Server);
            if (StateHelper.SelectedServer != null)
            {
                IsConnectedServer = StateHelper.SelectedServer.ServerId == Server.ServerId;
            }

            NavigationManager.NavigateTo("/Profiles");
        }
    }

    private async Task RunDeleteTask()
    {
        if (StateHelper.SelectedServer != null)
        {
            StateHelper.LogoutAndDispose();
            IsConnectedServer = false;
        }

        var dialog = await DialogService.ShowAsync<ServerRemoveDialog>("ServerRemoveDialog", ConfigHelper.DialogOptions);
        var result = await dialog.Result;

        if (result?.Canceled is false)
        {
            ServerList.Remove(Server);
            await ServerListChanged.InvokeAsync(ServerList);

            ConfigHelper.SetServers(ServerList);
        }
    }

}
