@inject IDialogService DialogService
@inject NavigationManager NavigationManager
@inject StateHelper StateHelper
@inject ConfigHelper ConfigHelper

<MudItem md="4">
    <MudCard Class="mud-background-gray border-2 border-solid mud-border-lines-default">
        <MudCardHeader>
            <CardHeaderContent>
                <MudText Class="mb-n4 no-pointers no-select" Typo="Typo.caption">Name:</MudText>
                <MudText Typo="Typo.body1">@Server.Name</MudText>
            </CardHeaderContent>
            <CardHeaderActions>
                @if (Server.Locked)
                {
                    <MudTooltip Arrow="true" Placement="Placement.Left" Text="Protected from edits">
                        <MudIconButton Icon="@Icons.Material.Filled.Settings" Color="Color.Default" Disabled="true"/>
                    </MudTooltip>
                }
                else
                {
                    <MudTooltip Arrow="true" Placement="Placement.Left" Text="Edit server">
                        <MudIconButton Icon="@Icons.Material.Filled.Settings" Color="Color.Default" @onclick="RunEditTask"/>
                    </MudTooltip>
                }
            </CardHeaderActions>
        </MudCardHeader>
        <MudCardContent Class="py-2">
            <MudText Class="mb-n3 no-pointers no-select" Typo="Typo.caption">Address:</MudText>
            <MudText Typo="Typo.body1">@Server.IpAddress</MudText>
        </MudCardContent>
        <MudCardActions Class="pa-4 d-flex mt-2">
            <MudTooltip Arrow="true" Placement="Placement.Right" Text="@(isConnectedServer ? "Connected" : "Disconnected")">
                <MudIcon Class="mb-n2" Icon="@Icons.Material.Filled.Circle" Color="@(isConnectedServer ? Color.Success : Color.Error)"/>
            </MudTooltip>
            <MudSpacer/>
            <MudTooltip Arrow="true" Placement="Placement.Left" Text="@(!isConnectedServer ? "Login to server" : "Logout of server")">
                <MudIconButton Class="mr-1" Color="Color.Success" Icon="@(!isConnectedServer ? Icons.Material.Filled.Login : Icons.Material.Filled.Logout)" Size="Size.Small" @onclick="RunLoginTask"/>
            </MudTooltip>
            @if (Server.Locked)
            {
                <MudTooltip Arrow="true" Placement="Placement.Left" Text="Protected from edits">
                    <MudIconButton Color="Color.Tertiary" Icon="@Icons.Material.Filled.Lock" Size="Size.Small"/>
                </MudTooltip>
            }
            else
            {
                <MudTooltip Arrow="true" Placement="Placement.Left" Text="Delete server">
                    <MudIconButton Color="Color.Error" Icon="@Icons.Material.Filled.Delete" Size="Size.Small" @onclick="RunDeleteTask"/>
                </MudTooltip>
            }
        </MudCardActions>
    </MudCard>
</MudItem>

@code {
    [Parameter]
    public Server Server { get; set; }

    [Parameter]
    public List<Server> ServerList { get; set; }

    [Parameter]
    public EventCallback<List<Server>> ServerListChanged { get; set; }

    private bool isConnectedServer { get; set; }

    protected override void OnInitialized()
    {
        isConnectedServer = StateHelper.SelectedServer?.ServerId == Server.ServerId;
        base.OnInitialized();
    }

    private async Task RunEditTask()
    {
        if (StateHelper.SelectedServer?.ServerId == Server.ServerId)
        {
            StateHelper.LogoutAndDispose();
            isConnectedServer = false;
        }

        var param = new DialogParameters
        {
            {
                "Server", Server
            }
        };

        var dialog = await DialogService.ShowAsync<ServerEditDialog>("ServerEditDialog", param, ConfigHelper.DialogOptions);
        var result = await dialog.Result;

        if (result?.Canceled is false)
        {
            var serverToChange = ServerList.FirstOrDefault(x => x.ServerId == Server.ServerId);

            if (serverToChange != null)
            {
                serverToChange.Name = Server.Name;
                serverToChange.IpAddress = Server.IpAddress;
            }

            ConfigHelper.SetServers(ServerList);
            await ServerListChanged.InvokeAsync(ServerList);
        }
    }

    private async Task RunLoginTask()
    {
        if (StateHelper.SelectedServer != null)
        {
            if (StateHelper.SelectedServer.ServerId == Server.ServerId)
            {
                StateHelper.LogoutAndDispose();
                isConnectedServer = false;
                return;
            }

            StateHelper.LogoutAndDispose();
            isConnectedServer = false;
        }

        var param = new DialogParameters
        {
            {
                "Server", Server
            }
        };

        var dialog = await DialogService.ShowAsync<ServerLoginDialog>("ServerLoginDialog", param, ConfigHelper.DialogOptions);
        var result = await dialog.Result;

        if (result?.Canceled is false)
        {
            StateHelper.SetSelectedServer(Server);
            if (StateHelper.SelectedServer != null)
            {
                isConnectedServer = StateHelper.SelectedServer.ServerId == Server.ServerId;
            }

            NavigationManager.NavigateTo("/Profiles");
        }
    }

    private async Task RunDeleteTask()
    {
        if (StateHelper.SelectedServer != null)
        {
            StateHelper.LogoutAndDispose();
            isConnectedServer = false;
        }

        var dialog = await DialogService.ShowAsync<ServerRemoveDialog>("ServerRemoveDialog", ConfigHelper.DialogOptions);
        var result = await dialog.Result;

        if (result?.Canceled is false)
        {
            ServerList.Remove(Server);
            await ServerListChanged.InvokeAsync(ServerList);

            ConfigHelper.SetServers(ServerList);
        }
    }

}
