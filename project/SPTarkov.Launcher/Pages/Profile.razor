@page "/Profile"
@using SPTarkov.Core.Models.Spt

@inject StateHelper StateHelper
@inject GameHelper GameHelper
@inject ILogger<Profile> Logger
@inject NavigationManager NavigationManager
@inject LocaleHelper LocaleHelper
@inject ConfigHelper ConfigHelper
@inject ISnackbar Snackbar

<MudContainer Class="px-4 my-2" MaxWidth="MaxWidth.Large">
    <MudContainer Class="pa-0 pb-4 d-flex flex-row justify-space-between">
        <MudButton Class="mud-button-border-copy border-2 border-solid mud-button-inner-text-copy" Disabled="@_buttonDisabled" Variant="Variant.Filled" Color="Color.Dark" OnClick="ReturnToProfiles" StartIcon="@Icons.Material.Filled.ArrowBack" Size="Size.Medium" IconColor="Color.Error">@(LocaleHelper.Get("profile_logout"))</MudButton>
        <MudSpacer/>
        <MudButton Class="mud-button-border-copy border-2 border-solid mud-button-inner-text-copy" Disabled="@_buttonDisabled" Variant="Variant.Filled" Color="Color.Dark" OnClick="StartGameTask" EndIcon="@Icons.Material.Filled.ArrowForward" Size="Size.Medium" IconColor="Color.Success">@(LocaleHelper.Get("profile_start_game"))</MudButton>
    </MudContainer>
    <MudContainer Class="pa-0 mb-4 d-flex flex-row gap-4 justify-center">
        <ProfileLevelComponent CurrentExp="SelectedMiniProfile.CurrentExp" CurrentLevel="SelectedMiniProfile.CurrentLevel" NeededExp="SelectedMiniProfile.NextLevel"/>
    </MudContainer>
    <MudContainer Class="pa-0 mb-4">
        <MudPaper Elevation="2" Class="pa-2 px-2 d-flex flex-row justify-center gap-8 mud-background-gray border-2 border-solid mud-border-lines-default card-container">
            <MudText Typo="Typo.h6">₽: 1,000,000,000</MudText>
            <MudText Typo="Typo.h6">$: 1,000,000</MudText>
            <MudText Typo="Typo.h6">€: 1,000,000</MudText>
            <MudText Typo="Typo.h6">GP: 69</MudText>
        </MudPaper>
    </MudContainer>
    <MudContainer Class="pa-0 mb-4 d-flex flex-row gap-4 justify-center">
        <ProfileCardComponent MiniProfile="SelectedMiniProfile" HideButtons="true"/>
        <ProfileStatsComponent MiniProfile="SelectedMiniProfile"/>
    </MudContainer>
</MudContainer>

@code {
    private MiniProfile SelectedMiniProfile { get; set; }
    private bool _buttonDisabled;

    protected override void OnInitialized()
    {
        SelectedMiniProfile = StateHelper.SelectedProfile;
        Logger.LogInformation("Selected profile: {Username}", SelectedMiniProfile?.Username);
        base.OnInitialized();
    }

    /// <summary>
    /// Wrap the StartGame method to easily control navigation.
    /// </summary>
    private async Task StartGameTask()
    {
        _buttonDisabled = true;
        StateHelper.SetAllowNavigation(false);

        await StartGame();

        _buttonDisabled = false;
        if (ConfigHelper.GetConfig().MinimizeOnLaunch)
        {
            Launcher.App.MainWindow.SetMinimized(false);
        }

        StateHelper.SetAllowNavigation(true);
    }

    private async Task StartGame()
    {
        Snackbar.Add(LocaleHelper.Get("profile_page_task_1"));
        if (!await GameHelper.CheckGame())
        {
            var message = GameHelper.ErrorMessage;
            Snackbar.Add($"{LocaleHelper.Get("profile_page_task_1_fail")}: {message}", Severity.Error);
            return;
        }

        Snackbar.Add(LocaleHelper.Get("profile_page_task_2"));
        if (!await GameHelper.PatchGame())
        {
            var message = GameHelper.ErrorMessage;
            Snackbar.Add($"{LocaleHelper.Get("profile_page_task_2_fail")}: {message}", Severity.Error);
            return;
        }

        Snackbar.Add(LocaleHelper.Get("profile_page_task_3"));
        if (!await GameHelper.LaunchGame())
        {
            var message = GameHelper.ErrorMessage;
            Snackbar.Add($"{LocaleHelper.Get("profile_page_task_3_fail")}: {message}", Severity.Error);
            return;
        }

        if (ConfigHelper.GetConfig().MinimizeOnLaunch)
        {
            Launcher.App.MainWindow.SetMinimized(true);
        }

        if (!await GameHelper.MonitorGame())
        {
            Snackbar.Add(LocaleHelper.Get("profile_page_game_closed"), Severity.Info);
        }
    }

    private void ReturnToProfiles()
    {
        StateHelper.SetSelectedProfile(null);
        NavigationManager.NavigateTo("/ServerPageWrapper/false");
    }

}
