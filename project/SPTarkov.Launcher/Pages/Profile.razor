@page "/Profile"

@inject StateHelper StateHelper
@inject GameHelper GameHelper
@inject ILogger<Profile> Logger
@inject NavigationManager NavigationManager
@inject LocaleHelper LocaleHelper
@inject ConfigHelper ConfigHelper
@inject ISnackbar Snackbar
@inject HttpHelper HttpHelper

<MudContainer Class="px-4 my-2" MaxWidth="MaxWidth.Large">
    <MudContainer Class="pa-0 pb-4 d-flex flex-row justify-space-between">
        <MudButton Class="mud-button-border-copy border-2 border-solid mud-button-inner-text-copy" Disabled="@_buttonDisabled" Variant="Variant.Filled" Color="Color.Dark" OnClick="ReturnToProfiles" StartIcon="@Icons.Material.Filled.ArrowBack" Size="Size.Medium" IconColor="Color.Error">@(LocaleHelper.Get("profile_logout"))</MudButton>
        <MudSpacer/>
        <MudTooltip Arrow="false" Placement="Placement.Bottom" ShowOnHover="true">
            <ChildContent>
                <MudPaper Elevation="2" Class="pa-2 px-2 d-flex flex-row justify-center gap-8 mud-background-gray border-2 border-solid mud-border-lines-default card-container mr-2">
                    <MudCheckBox @bind-Value="CheckboxForWipe" Class="wipe-checkbox" Disabled="@_buttonDisabled">Wipe?</MudCheckBox>
                </MudPaper>
            </ChildContent>
            <TooltipContent>
                <MudContainer Class="d-flex flex-column align-start justify-start">
                    <MudText>The below will NOT be wiped;</MudText>
                    <MudText>- Achievements.</MudText>
                    <MudText>- Prestige.</MudText>
                    <MudText>- Rewards from those.</MudText>
                    <MudText>- Some Account level stats.</MudText>
                </MudContainer>
            </TooltipContent>
        </MudTooltip>
        <MudButton Class="mud-button-border-copy border-2 border-solid mud-button-inner-text-copy" Disabled="@_buttonDisabled" Variant="Variant.Filled" Color="Color.Dark" OnClick="StartGameTask" EndIcon="@Icons.Material.Filled.ArrowForward" Size="Size.Medium" IconColor="Color.Success">@(LocaleHelper.Get("profile_start_game"))</MudButton>
    </MudContainer>
    <MudContainer Class="pa-0 mb-4 d-flex flex-row gap-4 justify-center">
        <ProfileLevelComponent CurrentExp="SelectedMiniProfile.CurrentExp" CurrentLevel="SelectedMiniProfile.CurrentLevel" NeededExp="SelectedMiniProfile.NextLevel"/>
    </MudContainer>
    <MudContainer Class="pa-0 mb-4">
        <MudPaper Elevation="2" Class="pa-2 px-2 d-flex flex-row justify-center gap-8 mud-background-gray border-2 border-solid mud-border-lines-default card-container">
            <MudText Typo="Typo.h6">₽: 1,000,000,000</MudText>
            <MudText Typo="Typo.h6">$: 1,000,000</MudText>
            <MudText Typo="Typo.h6">€: 1,000,000</MudText>
            <MudText Typo="Typo.h6">GP: 69</MudText>
        </MudPaper>
    </MudContainer>
    <MudContainer Class="pa-0 mb-4 d-flex flex-row gap-4 justify-center">
        <ProfileCardComponent MiniProfile="SelectedMiniProfile" HideButtons="true"/>
        <ProfileStatsComponent MiniProfile="SelectedMiniProfile"/>
    </MudContainer>
</MudContainer>

@code {
    private bool CheckboxForWipe { get; set; }
    private MiniProfile SelectedMiniProfile { get; set; }
    private bool _buttonDisabled;

    protected override void OnInitialized()
    {
        SelectedMiniProfile = StateHelper.SelectedProfile;
        Logger.LogInformation("Selected profile: {Username}", SelectedMiniProfile?.Username);
        base.OnInitialized();
    }

    /// <summary>
    /// Wrap the StartGame method to easily control navigation.
    /// </summary>
    private async Task StartGameTask()
    {
        _buttonDisabled = true;
        StateHelper.SetAllowNavigation(false);

        await StartGame();
        await RefreshProfiles();

        _buttonDisabled = false;
        if (ConfigHelper.GetConfig().MinimizeOnLaunch)
        {
            Launcher.App.MainWindow.SetMinimized(false);
        }

        StateHelper.SetAllowNavigation(true);
    }

    private async Task RefreshProfiles()
    {
        Snackbar.Add("CHANGE ME TO USE LOCALE SYSTEM Requesting Profile Updates");
        if (await GetUpdatedProfiles())
        {
            // if this succeeded, we dont need to go further
            StateHasChanged();
            return;
        }

        if (await GetUpdatedProfile())
        {
            // if this succeeded, we dont need to go further
            StateHasChanged();
            return;
        }

        // if we get here, something fucked up
    }

    private async Task<bool> GetUpdatedProfile()
    {
        var token = new CancellationTokenSource(TimeSpan.FromSeconds(10));
        try
        {
            var returnResult = await HttpHelper.GameServerGet<ProfileResponse>(RequestUrl.Profile, token.Token);
            StateHelper.SelectedProfile = returnResult.Response;
            var result = returnResult.Response;

            if (result is null)
            {
                return false;
            }

            SelectedMiniProfile = StateHelper.SelectedProfile;

            token?.Dispose();
            return true;
        }
        catch (Exception e)
        {
            Logger.LogInformation("Exception occured in updating profile: {e}", e);
            token?.Cancel();
            return false;
        }
    }

    private async Task<bool> GetUpdatedProfiles()
    {
        var token = new CancellationTokenSource(TimeSpan.FromSeconds(10));
        try
        {
            var returnResult = await HttpHelper.GameServerGet<ProfilesResponse>(RequestUrl.Profiles, token.Token);
            StateHelper.ProfileList = returnResult.Response;
            var result = returnResult.Response;

            if (result is null || !result.Any())
            {
                return false;
            }

            StateHelper.SelectedProfile = StateHelper.ProfileList?.FirstOrDefault(x => x.ProfileId == SelectedMiniProfile.ProfileId);
            SelectedMiniProfile = StateHelper.SelectedProfile;

            token?.Dispose();
            return true;
        }
        catch (Exception e)
        {
            Logger.LogInformation("Exception occured in updating profiles: {e}", e);
            token?.Cancel();
            return false;
        }
    }

    private async Task StartGame()
    {
        Snackbar.Add(LocaleHelper.Get("profile_page_task_1"));
        if (!await GameHelper.CheckGame())
        {
            var message = GameHelper.ErrorMessage;
            Snackbar.Add($"{LocaleHelper.Get("profile_page_task_1_fail")}: {message}", Severity.Error);
            return;
        }

        // initial snackbar.add is inside wipeprofile for this one
        if (CheckboxForWipe && !await WipeProfile())
        {
            var message = GameHelper.ErrorMessage;
            Snackbar.Add($"CHANGE ME TO USE LOCALE SYSTEM unable to wipe profile: {message}", Severity.Error);
            return;
        }

        Snackbar.Add(LocaleHelper.Get("profile_page_task_2"));
        if (!await GameHelper.PatchGame())
        {
            var message = GameHelper.ErrorMessage;
            Snackbar.Add($"{LocaleHelper.Get("profile_page_task_2_fail")}: {message}", Severity.Error);
            return;
        }

        Snackbar.Add(LocaleHelper.Get("profile_page_task_3"));
        if (OperatingSystem.IsWindows())
        {

            if (!await GameHelper.LaunchGame())
            {
                var message = GameHelper.ErrorMessage;
                Snackbar.Add($"{LocaleHelper.Get("profile_page_task_3_fail")}: {message}", Severity.Error);
                return;
            }
        }
        else if (OperatingSystem.IsLinux())
        {
            if (!await GameHelper.LaunchGameLinux())
            {
                var message = GameHelper.ErrorMessage;
                Snackbar.Add($"{LocaleHelper.Get("profile_page_task_3_fail")}: {message}", Severity.Error);
                return;
            }
        }

        if (ConfigHelper.GetConfig().MinimizeOnLaunch)
        {
            Launcher.App.MainWindow.SetMinimized(true);
        }

        if (!await GameHelper.MonitorGame())
        {
            Snackbar.Add(LocaleHelper.Get("profile_page_game_closed"), Severity.Info);
        }
    }

    private void ReturnToProfiles()
    {
        StateHelper.SetSelectedProfile(null);
        NavigationManager.NavigateTo("/ServerPageWrapper/false");
    }

    public async Task<bool> WipeProfile()
    {
        Snackbar.Add("CHANGE ME TO USE LOCALE SYSTEM Wiping profile with server");
        var token = new CancellationTokenSource(TimeSpan.FromSeconds(10));
        try
        {
            var wipeRequest = new RegisterRequest()
            {
                Edition = SelectedMiniProfile.Edition,
                Username = SelectedMiniProfile.Username
            };

            var returnResult = await HttpHelper.GameServerPut<WipeResponse>(RequestUrl.Wipe, wipeRequest, token.Token);
            StateHelper.ProfileList = returnResult.Profiles;
            var result = returnResult.Response;

            if (!result)
            {
                return false;
            }

            token?.Dispose();
            return true;
        }
        catch (Exception)
        {
            token?.Cancel();
            return false;
        }
    }

}
