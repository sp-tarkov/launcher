@page "/Profile"

@inject StateHelper StateHelper
@inject GameHelper GameHelper
@inject ILogger<Profile> Logger
@inject NavigationManager NavigationManager
@inject LocaleHelper LocaleHelper
@inject ConfigHelper ConfigHelper
@inject ISnackbar Snackbar

<MudContainer Class="px-4 my-2" MaxWidth="MaxWidth.Large">
    <MudContainer Class="pa-0 pb-4 d-flex flex-row justify-space-between">
        <MudButton Disabled="@_buttonDisabled" Variant="Variant.Filled" Color="Color.Dark" OnClick="ReturnToProfiles" StartIcon="@Icons.Material.Filled.ArrowBack" Size="Size.Medium" IconColor="Color.Error">@(LocaleHelper.Get("profile_logout"))</MudButton>
        <MudSpacer/>
        <MudButton Disabled="@_buttonDisabled" Variant="Variant.Filled" Color="Color.Primary" OnClick="StartGame" EndIcon="@Icons.Material.Filled.ArrowRight">@(LocaleHelper.Get("profile_start_game"))</MudButton>
    </MudContainer>
    <MudContainer Class="pa-0 mb-2">
        <MudPaper Elevation="2" Class="pa-2 px-2 d-flex flex-row justify-center gap-8">
            <MudText Typo="Typo.h6">@selectedMiniProfile.Username</MudText>
            <MudText Typo="Typo.h6">@selectedMiniProfile.ProfileID</MudText>
            <MudText Typo="Typo.h6">@selectedMiniProfile.Edition</MudText>
            <MudText Typo="Typo.h6">@selectedMiniProfile.SptData.Version</MudText>
        </MudPaper>
    </MudContainer>
    <MudContainer Class="pa-0 mb-2">
        <MudPaper Elevation="2" Class="pa-2 px-2 d-flex flex-row justify-center gap-8">
            <MudText Typo="Typo.h6">₽: 1,000,000,000</MudText>
            <MudText Typo="Typo.h6">$: 1,000,000,000</MudText>
            <MudText Typo="Typo.h6">€: 1,000,000,000</MudText>
            <MudText Typo="Typo.h6">GP: 1,000,000,000</MudText>
        </MudPaper>
    </MudContainer>
    <MudContainer Class="pa-0 pb-4">
        <ProfileStatsComponent MiniProfile="@selectedMiniProfile"/>
    </MudContainer>
</MudContainer>

@code {
    private MiniProfile selectedMiniProfile { get; set; }
    private bool _buttonDisabled;

    protected override void OnInitialized()
    {
        selectedMiniProfile = StateHelper.SelectedProfile;
        Logger.LogInformation("Selected profile: {Username}", selectedMiniProfile?.Username);
        base.OnInitialized();
    }

    private async Task StartGame()
    {
        // set play button to disabled while game is open
        _buttonDisabled = true;
        StateHelper.SetAllowNavigation(false);

        Snackbar.Add(LocaleHelper.Get("profile_page_task_1"));
        if (!await GameHelper.CheckGame())
        {
            var message = GameHelper.ErrorMessage;
            Snackbar.Add($"{LocaleHelper.Get("profile_page_task_1_fail")}: {message}", Severity.Error);
            return;
        }

        Snackbar.Add(LocaleHelper.Get("profile_page_task_2"));
        if (!await GameHelper.PatchGame())
        {
            var message = GameHelper.ErrorMessage;
            Snackbar.Add($"{LocaleHelper.Get("profile_page_task_2_fail")}: {message}", Severity.Error);
            return;
        }

        Snackbar.Add(LocaleHelper.Get("profile_page_task_3"));
        if (!await GameHelper.LaunchGame())
        {
            var message = GameHelper.ErrorMessage;
            Snackbar.Add($"{LocaleHelper.Get("profile_page_task_3_fail")}: {message}", Severity.Error);
            return;
        }

        // call minimize on window
        if (ConfigHelper.GetConfig().MinimizeOnLaunch)
        {
            Launcher.App.MainWindow.SetMinimized(true);
        }

        if (!await GameHelper.MonitorGame())
        {
            Snackbar.Add(LocaleHelper.Get("profile_page_game_closed"), Severity.Info);
        }

        _buttonDisabled = false;

        if (ConfigHelper.GetConfig().MinimizeOnLaunch)
        {
            Launcher.App.MainWindow.SetMinimized(false);
        }

        StateHelper.SetAllowNavigation(true);
    }

    private async Task ReturnToProfiles()
    {
        StateHelper.SetSelectedProfile(null);
        NavigationManager.NavigateTo("/ServerPageWrapper");
    }
}
