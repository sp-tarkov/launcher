@page "/Profile"

@inject StateHelper StateHelper
@inject GameHelper GameHelper
@inject ILogger<Profile> Logger
@inject NavigationManager NavigationManager
@inject LocaleHelper LocaleHelper
@inject ConfigHelper ConfigHelper
@inject ISnackbar Snackbar

<MudContainer Class="px-8 my-2 pa-0" MaxWidth="MaxWidth.Large">
    <MudContainer Class="pa-0 pb-4">
        <MudButton Disabled="@_buttonDisabled" Variant="Variant.Filled" Color="Color.Dark" OnClick="ReturnToProfiles" StartIcon="@Icons.Material.Filled.ArrowBack" Size="Size.Medium" IconColor="Color.Error">@(LocaleHelper.Get("profile_logout"))</MudButton>
    </MudContainer>
    <MudContainer Class="pa-0 pb-4">
        <ProfileStatsComponent MiniProfile="@selectedMiniProfile"/>
    </MudContainer>
    <MudContainer Class="d-flex pa-0 pb-4">
        <MudPaper Elevation="2" Class="pa-4 mr-4">
            <MudImage Src="https://placehold.co/150" Elevation="25" Class="rounded-lg"
                      FallbackSrc="https://placehold.co/150"/>
        </MudPaper>
        <MudPaper Elevation="2" Class="pa-4 d-flex flex-column justify-space-between mr-4">
            <MudText Class="mb-n2 no-pointers no-select" Typo="Typo.caption">₽:</MudText>
            <MudText Typo="Typo.h6">1,000,000,000</MudText>
            <MudText Class="mb-n2 no-pointers no-select" Typo="Typo.caption">$:</MudText>
            <MudText Typo="Typo.h6">1,000,000,000</MudText>
            <MudText Class="mb-n2 no-pointers no-select" Typo="Typo.caption">€:</MudText>
            <MudText Typo="Typo.h6">1,000,000,000</MudText>
            <MudText Class="mb-n2 no-pointers no-select" Typo="Typo.caption">GP:</MudText>
            <MudText Typo="Typo.h6">1,000,000,000</MudText>
        </MudPaper>
        <MudButton Disabled="@_buttonDisabled" Variant="Variant.Filled" Color="Color.Primary" OnClick="StartGame" EndIcon="@Icons.Material.Filled.ArrowRight">@(LocaleHelper.Get("profile_start_game"))</MudButton>
    </MudContainer>
</MudContainer>

@code {
    private MiniProfile selectedMiniProfile { get; set; }
    private bool _buttonDisabled;

    protected override void OnInitialized()
    {
        selectedMiniProfile = StateHelper.SelectedProfile;
        Logger.LogInformation($"Selected profile: {selectedMiniProfile?.Username}");
        base.OnInitialized();
    }

    private async Task StartGame()
    {
        // set play button to disabled while game is open
        _buttonDisabled = true;
        StateHelper.SetAllowNavigation(false);

        Snackbar.Add($"Launching Game");
        if (!await GameHelper.LaunchGame())
        {
            var message = GameHelper.ErrorMessage;
            Snackbar.Add($"Game Failed to start: {message}", Severity.Error);
            return;
        }

        // call minimize on window
        if (ConfigHelper.GetConfig().MinimizeOnLaunch)
        {
            Launcher.App.MainWindow.SetMinimized(true);
        }

        if (!await GameHelper.MonitorGame())
        {
            Snackbar.Add("Game has closed", Severity.Info);
        }

        _buttonDisabled = false;

        if (ConfigHelper.GetConfig().MinimizeOnLaunch)
        {
            Launcher.App.MainWindow.SetMinimized(false);
        }

        StateHelper.SetAllowNavigation(true);
    }

    private async Task ReturnToProfiles()
    {
        StateHelper.SetSelectedProfile(null);
        NavigationManager.NavigateTo("/Profiles");
    }
}
