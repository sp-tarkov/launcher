@page "/ModLoader"

@implements IDisposable

@inject ModManager ModManager
@inject IDialogService DialogService
@inject ModHelper ModHelper
@inject ConfigHelper ConfigHelper

<MudContainer Class="px-4 my-2 page-animation-switch" MaxWidth="MaxWidth.Large">
    <MudGrid Spacing="4" Justify="Justify.SpaceEvenly">
        <MudItem sm="6" Class="uninstalled">
            <MudPaper Elevation="2" Class="pa-4 d-flex flex-column flex-none gap-2 border-2 border-solid mud-border-lines-default card-container">
                <MudContainer Class="d-flex flex-row">
                    <MudText Class="flex-auto" Typo="Typo.h6" Align="Align.Center" Color="Color.Default">Uninstalled Mods</MudText>
                    <MudTooltip Class="flex-1" Arrow="false" ShowOnHover="true" ShowOnFocus="false" ShowOnClick="false" Text="Check for mod updates" Placement="Placement.Left">
                        <MudIconButton Size="Size.Small" Icon="@Icons.Material.Filled.Update" Color="Color.Info" OnClick="OpenUpdateDialog"/>
                    </MudTooltip>
                </MudContainer>
                @foreach (var (name, item) in ModHelper.GetModTasks())
                {
                    @if (item.Complete && item.Error is null)
                    {
                        continue;
                    }

                    // Download with error
                    @if (item.Error is not null && item is DownloadTask downloadTask1)
                    {
                        <MudLink Class="setting-on-hover pa-1 d-inline-block mud-width-full d-flex flex-row" Underline="Underline.None" Color="Color.Default">
                            <MudTooltip Text="@item.Error.ToString()">
                                <MudContainer Class="d-flex flex-row pa-0">
                                    <MudContainer Class="text-overflow py-2 px-1">
                                        <MudText HtmlTag="span">
                                            @($"{downloadTask1.ForgeMod.Name} - {downloadTask1.Version.Version}")
                                        </MudText>
                                    </MudContainer>
                                    <MudTooltip Arrow="false" ShowOnHover="true" ShowOnFocus="false" ShowOnClick="false" Text="Cancel" Placement="Placement.Left">
                                        <MudIconButton Size="Size.Small" Icon="@Icons.Material.Filled.Cancel" Color="Color.Error" OnClick="() => ModHelper.CancelModTask(name)"/>
                                    </MudTooltip>
                                </MudContainer>

                            </MudTooltip>
                        </MudLink>

                        continue;
                    }

                    @if (item is DownloadTask downloadTask2)
                    {
                        <MudLink Class="setting-on-hover pa-1 d-inline-block mud-width-full d-flex flex-row" Underline="Underline.None" Color="Color.Default">

                            <MudContainer Class="d-flex flex-row pa-0">
                                <MudContainer Class="text-overflow py-2 px-1">
                                    <MudText HtmlTag="span">
                                        @($"{downloadTask2.ForgeMod.Name} - {downloadTask2.Version.Version}")
                                    </MudText>
                                    <MudProgressLinear Rounded="true" Color="Color.Info" Size="Size.Small" Value="@item.Progress" Min="0" Max="100" Class="mt-2">
                                        <ChildContent>
                                            <MudText Color="Color.Default" Class="progress-bar">@item.Progress.ToString("F2")%</MudText>
                                        </ChildContent>
                                    </MudProgressLinear>
                                </MudContainer>
                                <MudTooltip Arrow="false" ShowOnHover="true" ShowOnFocus="false" ShowOnClick="false" Text="Cancel" Placement="Placement.Left">
                                    <MudIconButton Size="Size.Small" Icon="@Icons.Material.Filled.Cancel" Color="Color.Error" OnClick="() => ModHelper.CancelModTask(name)"/>
                                </MudTooltip>
                            </MudContainer>

                        </MudLink>
                    }
                    else if (item is UpdateTask updateTask)
                    {
                        <MudLink Class="setting-on-hover pa-1 d-inline-block mud-width-full d-flex flex-row" Underline="Underline.None" Color="Color.Default">

                            <MudContainer Class="d-flex flex-row pa-0">
                                <MudContainer Class="text-overflow py-2 px-1">
                                    <MudText HtmlTag="span">
                                        @($"{updateTask.ModName} - {updateTask.Version}")
                                    </MudText>
                                    <MudProgressLinear Rounded="true" Color="Color.Info" Size="Size.Small" Value="@item.Progress" Min="0" Max="100" Class="mt-2">
                                        <ChildContent>
                                            <MudText Color="Color.Default" Class="progress-bar">@item.Progress.ToString("F2")%</MudText>
                                        </ChildContent>
                                    </MudProgressLinear>
                                </MudContainer>
                                <MudTooltip Arrow="false" ShowOnHover="true" ShowOnFocus="false" ShowOnClick="false" Text="Cancel" Placement="Placement.Left">
                                    <MudIconButton Size="Size.Small" Icon="@Icons.Material.Filled.Cancel" Color="Color.Error" OnClick="() => ModHelper.CancelModTask(name)"/>
                                </MudTooltip>
                            </MudContainer>

                        </MudLink>
                    }
                    else if (item is InstallTask installTask)
                    {
                        <MudLink Class="setting-on-hover pa-1 d-inline-block mud-width-full d-flex flex-row" Underline="Underline.None" Color="Color.Default">

                            <MudContainer Class="d-flex flex-row pa-0">
                                <MudContainer Class="text-overflow py-2 px-1">
                                    <MudText HtmlTag="span">
                                        @($"{installTask.Mod.ModName} - {installTask.Mod.ModVersion}")
                                    </MudText>
                                    <MudProgressLinear Rounded="true" Color="Color.Info" Size="Size.Small" Indeterminate="true" Class="mt-2">
                                        <ChildContent>
                                            <MudText Color="Color.Default" Class="progress-bar">Unpacking, please wait!</MudText>
                                        </ChildContent>
                                    </MudProgressLinear>
                                </MudContainer>
                                <MudTooltip Arrow="false" ShowOnHover="true" ShowOnFocus="false" ShowOnClick="false" Text="Cancel" Placement="Placement.Left">
                                    <MudIconButton Size="Size.Small" Icon="@Icons.Material.Filled.Cancel" Color="Color.Error" OnClick="() => ModHelper.CancelModTask(name)"/>
                                </MudTooltip>
                            </MudContainer>

                        </MudLink>
                    }
                }
                @foreach (var (guid, mod) in ModManager.GetMods())
                {
                    if (mod.IsInstalled || mod.IsInstalling)
                    {
                        continue;
                    }

                    <MudLink Class="setting-on-hover pa-1 d-inline-block mud-width-full d-flex flex-row" Underline="Underline.None" Color="Color.Default">
                        <MudContainer Class="d-flex flex-row pa-0">
                            <MudContainer Class="text-overflow py-2 px-1">
                                <MudText HtmlTag="span">
                                    @($"{mod.ModName} - {mod.ModVersion}")
                                </MudText>
                            </MudContainer>
                            <MudContainer Class="flex-1 d-flex flex-row justify-center align-center pr-0">
                                @if (CheckForDependantBeforeDelete(guid))
                                {
                                    <MudTooltip Arrow="false" ShowOnHover="true" ShowOnFocus="false" ShowOnClick="false" Text="Install Mod" Placement="Placement.Left">
                                        <MudIconButton Size="Size.Small" Icon="@Icons.Material.Filled.InstallDesktop" Color="Color.Success" OnClick="() => ModManager.InstallMod(guid)"/>
                                    </MudTooltip>
                                    <MudTooltip Arrow="false" ShowOnHover="true" ShowOnFocus="false" ShowOnClick="false" Text="Another mod depends on this one, please delete that first!" Placement="Placement.Left">
                                        <MudIconButton Size="Size.Small" Icon="@Icons.Material.Filled.Delete" Color="Color.Error" OnClick="() => ModManager.DeleteMod(guid)" Disabled="true"/>
                                    </MudTooltip>
                                }
                                else
                                {
                                    <MudTooltip Arrow="false" ShowOnHover="true" ShowOnFocus="false" ShowOnClick="false" Text="Install Mod" Placement="Placement.Left">
                                        <MudIconButton Size="Size.Small" Icon="@Icons.Material.Filled.InstallDesktop" Color="Color.Success" OnClick="() => ModManager.InstallMod(guid)"/>
                                    </MudTooltip>
                                    <MudTooltip Arrow="false" ShowOnHover="true" ShowOnFocus="false" ShowOnClick="false" Text="Delete Mod" Placement="Placement.Left">
                                        <MudIconButton Size="Size.Small" Icon="@Icons.Material.Filled.Delete" Color="Color.Error" OnClick="() => ModManager.DeleteMod(guid)"/>
                                    </MudTooltip>
                                }
                            </MudContainer>
                        </MudContainer>
                    </MudLink>
                }
            </MudPaper>
        </MudItem>
        <MudItem sm="6" Class="installed">
            <MudPaper Elevation="2" Class="pa-4 d-flex flex-column flex-none gap-2 border-2 border-solid mud-border-lines-default card-container">
                <MudText Typo="Typo.h6" Align="Align.Center" Color="Color.Default">Installed Mods</MudText>
                @foreach (var (guid, mod) in ModManager.GetMods())
                {
                    if (!mod.IsInstalled)
                    {
                        continue;
                    }

                    <MudLink Class="setting-on-hover pa-1 d-inline-block mud-width-full d-flex flex-row" Underline="Underline.None" Color="Color.Default">
                        <MudContainer Class="d-flex flex-row pa-0">
                            <MudContainer Class="text-overflow py-2 px-1">
                                <MudText HtmlTag="span">
                                    @($"{mod.ModName} - {mod.ModVersion}")
                                </MudText>
                            </MudContainer>
                            @if (CheckForDependantThatIsInstalled(guid))
                            {
                                <MudTooltip Arrow="false" ShowOnHover="true" ShowOnFocus="false" ShowOnClick="false" Text="Another mod depends on this one, please uninstall that first!" Placement="Placement.Left">
                                    <MudIconButton Size="Size.Small" Icon="@Icons.Material.Filled.InstallDesktop" Disabled="true" Color="Color.Info"/>
                                </MudTooltip>
                                <MudTooltip Arrow="false" ShowOnHover="true" ShowOnFocus="false" ShowOnClick="false" Text="" Placement="Placement.Left" Disabled="true">
                                    <MudIconButton Size="Size.Small" Icon="@Icons.Material.Filled.Delete" Color="Color.Error" Disabled="true"/>
                                </MudTooltip>
                            }
                            else
                            {
                                <MudTooltip Arrow="false" ShowOnHover="true" ShowOnFocus="false" ShowOnClick="false" Text="Uninstall Mod" Placement="Placement.Left">
                                    <MudIconButton Size="Size.Small" Icon="@Icons.Material.Filled.InstallDesktop" Disabled="false" Color="Color.Info" OnClick="() => ModManager.UninstallMod(guid)"/>
                                </MudTooltip>
                                <MudTooltip Arrow="false" ShowOnHover="true" ShowOnFocus="false" ShowOnClick="false" Text="Delete Mod" Placement="Placement.Left">
                                    <MudIconButton Size="Size.Small" Icon="@Icons.Material.Filled.Delete" Color="Color.Error" OnClick="() => ModManager.DeleteMod(guid)"/>
                                </MudTooltip>
                            }
                        </MudContainer>
                    </MudLink>
                }
            </MudPaper>
        </MudItem>
    </MudGrid>
</MudContainer>

@code {
    private Timer _progressTimer;

    protected override Task OnAfterRenderAsync(bool firstRender)
    {
        _progressTimer = new Timer(_ => { InvokeAsync(StateHasChanged); }, default, TimeSpan.FromMilliseconds(500), TimeSpan.Zero);
        return base.OnAfterRenderAsync(firstRender);
    }

    public void Dispose()
    {
        _progressTimer?.Dispose();
    }

    private async Task OpenUpdateDialog()
    {
        var dialog = await DialogService.ShowAsync<ForgeUpdateDialog>("ForgeUpdateDialog", ConfigHelper.DialogOptions);
        var result = await dialog.Result;

        if (result?.Canceled is false)
        {
            await InvokeAsync(StateHasChanged);
        }
    }

    private bool CheckForDependantThatIsInstalled(string guid)
    {
        var list = ModManager.GetDependantMods(guid);
        if (!list.Any())
        {
            return false;
        }

        foreach (var configMod in list)
        {
            // only disable the uninstall button if a mod is installed that has the guid as a dep
            if (configMod.IsInstalled && configMod.Dependencies.ContainsKey(guid))
            {
                return true;
            }
        }

        return false;
    }

    // TODO : show name of dependant mod in ui
    private bool CheckForDependantBeforeDelete(string guid)
    {
        var list = ModManager.GetDependantMods(guid);
        if (!list.Any())
        {
            return false;
        }

        foreach (var configMod in list)
        {
            // only disable the delete button if a mod exists that has the guid as a dep
            if (configMod.Dependencies.ContainsKey(guid))
            {
                return true;
            }
        }

        return false;
    }
}
