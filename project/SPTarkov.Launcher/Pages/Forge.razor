@page "/Forge"

@inject IDialogService DialogService
@inject HttpHelper HttpHelper
@inject StateHelper StateHelper
@inject ConfigHelper ConfigHelper
@inject ILogger<Forge> Logger
@inject LocaleHelper LocaleHelper

<MudContainer Class="px-4 mt-2 mb-6" MaxWidth="MaxWidth.Large">
    @if (NetAvailable && ApiKeyAvailable)
    {
        <MudItem sm="12" Class="mb-6">
            <MudCard Class="mud-background-gray border-2 border-solid mud-border-lines-default px-4 pt-4 pb-2">
                <SearchComponent @bind-Search="Search" @bind-FilterValue="FilterValue" @bind-SortValue="SortValue" @bind-AiValue="AiValue" SearchFunc="@SearchUpdate"/>

                @if (SearchResponse?.Meta?.LastPage is not null && SearchResponse?.Data?.Count > 0)
                {
                    <MudItem sm="12" Class="d-flex justify-center">
                        <MudPagination Rectangular="true" Variant="Variant.Text" Count="@((int)SearchResponse.Meta.LastPage)" Class="mb-4"
                                       ShowFirstButton="true" ShowLastButton="true" ShowNextButton="true" ShowPreviousButton="true" @bind-Selected="@PaginationSelected"/>
                    </MudItem>
                }
            </MudCard>
        </MudItem>
    }

    @if (!NetAvailable)
    {
        <MudItem sm="12">
            <MudAlert Severity="Severity.Info" Variant="Variant.Outlined">No Internet access found, please fix and refresh!</MudAlert>
        </MudItem>
        <MudItem sm="12" Class="mt-4 d-flex justify-center align-center">
            <MudButton Size="Size.Small" Variant="Variant.Filled" Color="Color.Primary" StartIcon="@Icons.Material.Filled.Refresh" @onclick="CheckInternetAccess">Refresh</MudButton>
        </MudItem>
    }
    else if (!ApiKeyAvailable)
    {
        <MudPaper Elevation="2" Class="pa-4 d-flex flex-column flex-none gap-2 border-2 border-solid mud-border-lines-default card-container mud-height-full">
            <MudItem sm="12">
                <MudAlert Severity="Severity.Info" Variant="Variant.Outlined" Dense="true">No API Key found, please follow the instructions below to be able to use Forge!</MudAlert>
            </MudItem>
            <MudItem sm="12" Class="my-2 pa-2">
                <MudText Class="mb-1">To use Forge via the launcher you must:</MudText>
                <MudText>1. Have an account on the Forge.</MudText>
                <MudText>2. Login and generate an Api Key for you to use.</MudText>
                <MudText Class="mt-1">Below are two paths on how to generate that key.</MudText>
            </MudItem>
            <MudExpansionPanels MultiExpansion="true">
                <MudExpansionPanel Text="Email and password login">
                    <MudText>If you have a Email and password login we are able to get a key automatically,</MudText>
                    <MudText>This requires you to login via the button below.</MudText>
                    <MudAlert Dense="true" Severity="Severity.Info" Variant="Variant.Outlined" Class="my-2">None of your login details will be saved!</MudAlert>
                    <MudItem sm="12" Class="mt-4 d-flex justify-start">
                        <MudButton Size="Size.Small" Variant="Variant.Filled" Color="Color.Dark" StartIcon="@Icons.Material.Filled.Login" @onclick="StartForgeLoginTask">Login</MudButton>
                    </MudItem>
                </MudExpansionPanel>
                <MudExpansionPanel Text="Discord login">
                    <MudText>If you have a Discord login we are NOT able to get a key automatically,</MudText>
                    <MudText>This requires you to login via the Forge.</MudText>
                    <MudText Class="mt-2">1. Start by logging into <MudLink Href="https://forge.sp-tarkov.com">The Forge.</MudLink></MudText>
                    <MudText>2. Click your icon top right and select API Tokens.</MudText>
                    <MudText>3. Under "Token Name" put "SPT Launcher Key" and click create.</MudText>
                    <MudText>4. Click the button below to save this Token and test it.</MudText>
                    <MudItem sm="12" Class="mt-4 d-flex justify-start">
                        <MudButton Size="Size.Small" Variant="Variant.Filled" Color="Color.Dark" StartIcon="@Icons.Material.Filled.Login" @onclick="StartForgeDiscordTask">Login</MudButton>
                    </MudItem>
                </MudExpansionPanel>
            </MudExpansionPanels>
        </MudPaper>
    }
    else if (SearchResponse is null || SearchInProgress)
    {
        <MudGrid>
            <ModCardComponent IsSkeleton="true"/>
            <ModCardComponent IsSkeleton="true"/>
        </MudGrid>
    }
    else if (SearchResponse?.Data?.Count > 0)
    {
        <MudGrid>
            @foreach (var mod in SearchResponse.Data)
            {
                <ModCardComponent ForgeMod="@mod"/>
            }
        </MudGrid>
    }

</MudContainer>

@code {
    private bool NetAvailable { get; set; }
    private bool ApiKeyAvailable { get; set; }
    private ForgeModsResponse SearchResponse { get; set; }
    private bool SearchInProgress { get; set; }

    private int PaginationSelected
    {
        get => StateHelper.CurrentPagination;
        set
        {
            if (StateHelper.CurrentPagination == value)
            {
                return;
            }

            StateHelper.CurrentPagination = value;
            _ = SearchForMods(value);
        }
    }

    public string Search
    {
        get => StateHelper.CurrentSearch;
        set
        {
            if (StateHelper.CurrentSearch == value)
            {
                return;
            }

            StateHelper.CurrentSearch = value;
            _ = SearchUpdate();
        }
    }

    public string SortValue
    {
        get => StateHelper.CurrentSort;
        set
        {
            if (StateHelper.CurrentSort == value)
            {
                return;
            }

            StateHelper.CurrentSort = value;
            _ = SearchUpdate();
        }
    }

    public string FilterValue
    {
        get => StateHelper.CurrentFilter;
        set
        {
            if (StateHelper.CurrentFilter == value)
            {
                return;
            }

            StateHelper.CurrentFilter = value;
            _ = SearchUpdate();
        }
    }

    public string AiValue
    {
        get => StateHelper.CurrentAi;
        set
        {
            if (StateHelper.CurrentAi == value)
            {
                return;
            }

            StateHelper.CurrentAi = value;
            _ = SearchUpdate();
        }
    }

    protected override async Task OnInitializedAsync()
    {
        await base.OnInitializedAsync();
        NetAvailable = HttpHelper.IsInternetAccessAvailable();
        ApiKeyAvailable = !string.IsNullOrEmpty(HttpHelper.GetApiKey());

        if (!ApiKeyAvailable || !NetAvailable)
        {
            return;
        }

        await SearchForMods();
    }

    private void CheckInternetAccess()
    {
        NetAvailable = HttpHelper.IsInternetAccessAvailable();
    }

    private async Task SearchUpdate()
    {
        await SearchForMods(1);
    }

    private async Task SearchForMods(int? page = null)
    {
        SearchInProgress = true;
        page ??= StateHelper.CurrentPagination;

        try
        {
            var token = new CancellationTokenSource(TimeSpan.FromSeconds(10));
            SearchResponse = await HttpHelper.ForgeGetMods(token.Token, Search, SortValue, (int) page, FilterValue, AiValue);
        }
        catch (Exception e)
        {
            Logger.LogError("Exception thrown from ForgeHelper.SearchForMods {Exception}", e);
            return;
        }

        if (!SearchResponse!.Success)
        {
            Logger.LogError("Something failed");
            Logger.LogError("request info: Search: {Search}, SortValue: {SortValue}, page: {page}, FilterValue: {FilterValue}, AiValue: {AiValue}", Search, SortValue, page, FilterValue, AiValue);
            Logger.LogError("response: {SearchResponse}", SearchResponse);

            SearchResponse = null;
            ApiKeyAvailable = false;
        }

        PaginationSelected = (int) page;
        StateHelper.CurrentPagination = PaginationSelected;
        SearchInProgress = false;
        StateHasChanged();
    }

    private async Task StartForgeLoginTask()
    {
        var dialog = await DialogService.ShowAsync<ForgeLoginDialog>("ForgeLoginDialog", ConfigHelper.DialogOptions);
        var result = await dialog.Result;

        if (result?.Canceled is false)
        {
            ApiKeyAvailable = true;
            Logger.LogInformation("Saved Apikey");
            await SearchForMods();
        }
    }

    // TODO: see if Fridge is up for adding a apikey check endpoint
    // like ping/pong with validation
    private async Task StartForgeDiscordTask()
    {
        var dialog = await DialogService.ShowAsync<ForgeDiscordDialog>("ForgeDiscordDialog", ConfigHelper.DialogOptions);
        var result = await dialog.Result;

        if (result?.Canceled is false)
        {
            ApiKeyAvailable = true;
            Logger.LogInformation("Saved Apikey");
            await SearchForMods();
        }
    }
}
