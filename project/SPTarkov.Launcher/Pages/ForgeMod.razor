@page "/ForgeMod/{ModId}"

@inject HttpHelper HttpHelper
@inject ILogger<ForgeMod> Logger

<MudContainer Class="px-4 mt-2 mb-6" MaxWidth="MaxWidth.Large">
    <MudGrid>
        @if (SearchResponse is null || SearchInProgress || VersionResponse is null)
        {
            <DetailedModComponent IsSkeleton="true"/>
        }
        else if (SearchResponse?.Data is not null)
        {
            <DetailedModComponent ForgeMod="@SearchResponse?.Data" ForgeModVersion="@VersionResponse?.Data?.FirstOrDefault()" ForgeModAddons="@AddonResponse?.Data"/>
        }
    </MudGrid>
</MudContainer>

@code {
    private ForgeModResponse SearchResponse { get; set; }
    private ForgeVersionResponse VersionResponse { get; set; }
    private ForgeAddonResponse AddonResponse { get; set; }
    private bool SearchInProgress { get; set; }

    [Parameter]
    public string ModId { get; set; }

    protected override async Task OnInitializedAsync()
    {
        await base.OnInitializedAsync();
        await SearchForMod();
        await SearchForModVersion(ModId, SearchResponse.Data.Versions.FirstOrDefault().Id.ToString());
        await SearchForModAddons(ModId);

    }

    private async Task SearchForMod()
    {
        SearchInProgress = true;

        try
        {
            var token = new CancellationTokenSource(TimeSpan.FromSeconds(10));
            SearchResponse = await HttpHelper.ForgeGetMod(ModId, token.Token);
        }
        catch (Exception e)
        {
            Logger.LogError("Exception thrown from ForgeHelper.SearchForMod {Exception}", e);
            return;
        }

        SearchInProgress = false;
        StateHasChanged();
    }

    private async Task SearchForModVersion(string modId, string versionId)
    {
        try
        {
            var token = new CancellationTokenSource(TimeSpan.FromSeconds(10));
            VersionResponse = await HttpHelper.ForgeGetModVersion(modId, versionId, token.Token);
        }
        catch (Exception e)
        {
            Logger.LogError("Exception thrown from ForgeHelper.SearchForModVersion {Exception}", e);
            return;
        }

        if (!VersionResponse!.Success)
        {
            Logger.LogError("Getting Mod version failed {modId}:{versionId} for reason: {code}:{message}", modId, versionId, VersionResponse.Code, VersionResponse.Message);
        }

        StateHasChanged();
    }

    private async Task SearchForModAddons(string modId)
    {
        try
        {
            var token = new CancellationTokenSource(TimeSpan.FromSeconds(10));
            AddonResponse = await HttpHelper.ForgeGetModAddons(modId, token.Token);
        }
        catch (Exception e)
        {
            Logger.LogError("Exception thrown from ForgeHelper.SearchForModAddons {Exception}", e);
            return;
        }

        if (!VersionResponse!.Success)
        {
            Logger.LogError("Getting Mod Addons failed {modId} for reason: {code}:{message}", modId, VersionResponse.Code, VersionResponse.Message);
        }

        StateHasChanged();
    }
}
