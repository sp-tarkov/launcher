@page "/Profiles"

@inject IDialogService DialogService
@inject StateHelper StateHelper
@inject ConfigHelper ConfigHelper
@inject NavigationManager NavigationManager
@inject LocaleHelper LocaleHelper

<MudContainer Class="px-4 my-2" MaxWidth="MaxWidth.Large">
    <MudContainer Class="pa-0 d-flex justify-start gap-2 pb-4">
        <MudButton Class="mud-button-border-copy border-2 border-solid mud-button-inner-text-copy" Color="Color.Dark" StartIcon="@Icons.Material.Filled.ArrowBack" Size="Size.Medium" OnClick="ReturnToServers" Variant="Variant.Filled"
                   IconColor="Color.Error">@(LocaleHelper.Get("profiles_disconnect"))</MudButton>
        <MudButton Class="mud-button-border-copy border-2 border-solid mud-button-inner-text-copy" Color="Color.Dark" StartIcon="@Icons.Material.Filled.PersonAdd" Size="Size.Medium" OnClick="RunAddTask" Variant="Variant.Filled"
                   IconColor="Color.Success">@(LocaleHelper.Get("profiles_create"))</MudButton>
        <MudButton Class="mud-button-border-copy border-2 border-solid mud-button-inner-text-copy" Color="Color.Dark" StartIcon="@Icons.Material.Filled.Login" Size="Size.Medium" OnClick="RunLoginTaskWithDetails" Variant="Variant.Filled"
                   IconColor="Color.Success">@(LocaleHelper.Get("profiles_login"))</MudButton>
    </MudContainer>
    <MudGrid>
        @foreach (var profile in ProfilesList)
        {
            <ProfileCardComponent MiniProfile="@profile" @bind-ProfileList="ProfilesList"/>
        }

        @switch (ProfilesList.Count)
        {
            case 0 when IsConnected:
                <MudItem sm="12">
                    <MudPaper Elevation="2" Class="pa-4 d-flex flex-column flex-none gap-2 border-2 border-solid mud-border-lines-default card-container">
                        <MudAlert Severity="Severity.Info" Variant="Variant.Outlined">@(LocaleHelper.Get("profiles_empty_warning"))</MudAlert>
                    </MudPaper>
                </MudItem>
                break;
            case 0 when !IsConnected:
                <MudItem sm="12">
                    <MudPaper Elevation="2" Class="pa-4 d-flex flex-column flex-none gap-2 border-2 border-solid mud-border-lines-default card-container">
                        <MudAlert Severity="Severity.Info" Variant="Variant.Outlined">@(LocaleHelper.Get("profiles_connect_warning"))</MudAlert>
                    </MudPaper>
                </MudItem>
                break;
        }
    </MudGrid>
</MudContainer>

@code {
    private MiniProfile PartialProfile { get; set; }
    public List<MiniProfile> ProfilesList { get; set; }
    private bool IsConnected { get; set; }

    protected override void OnInitialized()
    {
        ProfilesList = StateHelper.ProfileList;
        IsConnected = StateHelper.SelectedServer is not null;
        base.OnInitialized();
    }

    private async Task RunAddTask()
    {
        var dialog = await DialogService.ShowAsync<ProfileAddDialog>("ProfileAddDialog", ConfigHelper.DialogOptions);
        var result = await dialog.Result;

        if (result?.Canceled is false)
        {
            ProfilesList = StateHelper.ProfileList;
        }
    }

    private async Task RunLoginTaskWithDetails()
    {
        var dialogParams = new DialogParameters
        {
            {
                "MiniProfile", PartialProfile
            }
        };

        var dialog = await DialogService.ShowAsync<ProfileLoginDialog>("ProfileLoginDialog", dialogParams, ConfigHelper.DialogOptions);
        var result = await dialog.Result;

        if (result?.Canceled is false)
        {
            var objectToUse = result.Data as MiniProfile;
            PartialProfile = objectToUse;
            StateHelper.SetSelectedProfile(objectToUse);
            NavigationManager.NavigateTo("/ServerPageWrapper/false");
        }
    }

    private Task ReturnToServers()
    {
        StateHelper.SetSelectedServer(null);
        NavigationManager.NavigateTo("/ServerPageWrapper/false");

        return Task.CompletedTask;
    }

}
