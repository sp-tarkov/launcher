@page "/Profiles"

@inject IDialogService DialogService
@inject StateHelper StateHelper
@inject ConfigHelper ConfigHelper
@inject NavigationManager NavigationManager
@inject LocaleHelper LocaleHelper

<MudContainer Class="px-4 my-2" MaxWidth="MaxWidth.Large">
    <MudContainer Class="pa-0 d-flex justify-start gap-2 pb-4">
        <MudButton Color="Color.Dark" StartIcon="@Icons.Material.Filled.ArrowBack" Size="Size.Medium" OnClick="ReturnToServers" Variant="Variant.Filled" IconColor="Color.Error">@(LocaleHelper.Get("profiles_disconnect"))</MudButton>
        <MudButton Color="Color.Dark" StartIcon="@Icons.Material.Filled.PersonAdd" Size="Size.Medium" OnClick="RunAddTask" Variant="Variant.Filled" IconColor="Color.Success">@(LocaleHelper.Get("profiles_create"))</MudButton>
        <MudButton Color="Color.Dark" StartIcon="@Icons.Material.Filled.Login" Size="Size.Medium" OnClick="RunLoginTaskWithDetails" Variant="Variant.Filled" IconColor="Color.Success">@(LocaleHelper.Get("profiles_login"))</MudButton>
    </MudContainer>
    <MudGrid>
        @foreach (var profile in ProfilesList)
        {
            <ProfileCardComponent MiniProfile="@profile" @bind-ProfileList="ProfilesList"/>
        }

        @switch (ProfilesList.Count)
        {
            case 0 when isConnected:
                <MudItem sm="12">
                    <MudAlert Severity="Severity.Info" Variant="Variant.Filled">@(LocaleHelper.Get("profiles_empty_warning"))</MudAlert>
                </MudItem>
                break;
            case 0 when !isConnected:
                <MudItem sm="12">
                    <MudAlert Severity="Severity.Info" Variant="Variant.Filled">@(LocaleHelper.Get("profiles_connect_warning"))</MudAlert>
                </MudItem>
                break;
        }
    </MudGrid>
</MudContainer>

@code {
    private MiniProfile _partialProfile { get; set; }
    public List<MiniProfile> ProfilesList { get; set; }
    private bool isConnected { get; set; }

    protected override void OnInitialized()
    {
        ProfilesList = StateHelper.ProfileList;
        isConnected = StateHelper.SelectedServer is not null;
        base.OnInitialized();
    }

    private async Task RunAddTask()
    {
        var dialog = await DialogService.ShowAsync<ProfileAddDialog>("ProfileAddDialog", ConfigHelper.DialogOptions);
        var result = await dialog.Result;

        if (result?.Canceled is false)
        {
            ProfilesList = StateHelper.ProfileList;
        }
    }

    private async Task RunLoginTaskWithDetails()
    {
        var dialogParams = new DialogParameters
        {
            {
                "MiniProfile", _partialProfile
            }
        };

        var dialog = await DialogService.ShowAsync<ProfileLoginDialog>("ProfileLoginDialog", dialogParams, ConfigHelper.DialogOptions);
        var result = await dialog.Result;

        if (result?.Canceled is false)
        {
            var objectToUse = result.Data as MiniProfile;
            _partialProfile = objectToUse;
            StateHelper.SetSelectedProfile(objectToUse);
            NavigationManager.NavigateTo("/ServerPageWrapper");
        }
    }

    private async Task ReturnToServers()
    {
        StateHelper.SetSelectedServer(null);
        NavigationManager.NavigateTo("/ServerPageWrapper");
    }
}
