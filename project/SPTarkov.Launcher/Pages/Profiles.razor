@page "/Profiles"

@inject IDialogService DialogService
@inject StateHelper StateHelper
@inject ConfigHelper ConfigHelper
@inject NavigationManager NavigationManager

<MudContainer Class="px-8 my-2" MaxWidth="MaxWidth.Large">
    <MudContainer Class="pa-0 d-flex justify-start gap-2 pb-4">
        <MudButton Color="Color.Dark" StartIcon="@Icons.Material.Filled.ArrowBack" Size="Size.Medium" OnClick="ReturnToServers" Variant="Variant.Filled" IconColor="Color.Error">Disconnect from server</MudButton>
        <MudButton Color="Color.Dark" StartIcon="@Icons.Material.Filled.PersonAdd" Size="Size.Medium" OnClick="RunAddTask" Variant="Variant.Filled" IconColor="Color.Success">Create New Profile</MudButton>
        <MudButton Color="Color.Dark" StartIcon="@Icons.Material.Filled.Login" Size="Size.Medium" OnClick="RunLoginTaskWithDetails" Variant="Variant.Filled" IconColor="Color.Success">Login with details</MudButton>
    </MudContainer>
    <MudGrid>
        @foreach (var profile in ProfilesList)
        {
            <ProfileCardComponent MiniProfile="@profile" @bind-ProfileList="ProfilesList"/>
        }

        @switch (ProfilesList.Count)
        {
            // TODO: server might hide profiles, but an edge case might be a fresh server
            case 0 when isConnected:
                <MudItem sm="12">
                    <MudAlert Severity="Severity.Info" Variant="Variant.Filled">Server has no profiles yet or does not show them. Please create a new profile or login with details.</MudAlert>
                </MudItem>
                break;
            case 0 when !isConnected:
                <MudItem sm="12">
                    <MudAlert Severity="Severity.Info" Variant="Variant.Filled">Please connect to a Server first!</MudAlert>
                </MudItem>
                break;
        }
    </MudGrid>
</MudContainer>

@code {
    private MiniProfile _partialProfile { get; set; }
    public List<MiniProfile> ProfilesList { get; set; }
    private bool isConnected { get; set; }

    protected override void OnInitialized()
    {
        ProfilesList = StateHelper.ProfileList;
        isConnected = StateHelper.SelectedServer is not null;
        base.OnInitialized();
    }

    private async Task RunAddTask()
    {
        var dialog = await DialogService.ShowAsync<ProfileAddDialog>("ProfileAddDialog", ConfigHelper.DialogOptions);
        var result = await dialog.Result;

        if (result?.Canceled is false)
        {
            ProfilesList = StateHelper.ProfileList;
        }
    }

    // TODO: currently does not work as intended
    private async Task RunLoginTaskWithDetails()
    {
        var dialogParams = new DialogParameters
        {
            {
                "MiniProfile", _partialProfile
            }
        };

        var dialog = await DialogService.ShowAsync<ProfileLoginDialog>("ProfileLoginDialog", dialogParams, ConfigHelper.DialogOptions);
        var result = await dialog.Result;

        if (result?.Canceled is false)
        {
            var objectToUse = result.Data as MiniProfile;
            _partialProfile = objectToUse;
            StateHelper.SetSelectedProfile(objectToUse);
            NavigationManager.NavigateTo("/Profile");
        }
    }

    private async Task ReturnToServers()
    {
        StateHelper.SetSelectedServer(null);
        NavigationManager.NavigateTo("/");
    }
}
